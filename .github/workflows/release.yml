name: Release on Version Bump

on:
  push:
    branches: [master]
    paths: [pyproject.toml]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for version change
        id: v
        shell: bash
        run: |
          new=$(python3 -c "
          import tomllib, pathlib
          print(tomllib.loads(pathlib.Path('pyproject.toml').read_text())['project']['version'])
          ")
          if git show HEAD^:pyproject.toml > /tmp/prev.toml 2>/dev/null; then
            old=$(python3 -c "
          import tomllib, pathlib
          print(tomllib.loads(pathlib.Path('/tmp/prev.toml').read_text())['project']['version'])
          ")
          else
            old=""
          fi
          echo "new=$new" >> "$GITHUB_OUTPUT"
          echo "old=$old" >> "$GITHUB_OUTPUT"
          if [ "$new" = "$old" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if version unchanged
        if: steps.v.outputs.changed != 'true'
        run: echo "Version unchanged; skipping release."

      - name: Set up uv
        if: steps.v.outputs.changed == 'true'
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5

      - name: Build
        if: steps.v.outputs.changed == 'true'
        run: |
          rm -rf dist/
          uv build

      - name: Create GitHub Release
        if: steps.v.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="v${{ steps.v.outputs.new }}"
          if gh release view "$tag" > /dev/null 2>&1; then
            gh release upload "$tag" dist/*.tar.gz dist/*.whl --clobber
          else
            gh release create "$tag" \
              --target "${{ github.sha }}" \
              --generate-notes \
              dist/*.tar.gz dist/*.whl
          fi

      - name: Publish to PyPI
        if: steps.v.outputs.changed == 'true'
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
