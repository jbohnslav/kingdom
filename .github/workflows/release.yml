name: Release on Version Bump

on:
  push:
    branches: [master]
    paths: [pyproject.toml]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for version change
        id: v
        shell: bash
        run: |
          new=$(python3 -c "
          import tomllib, pathlib
          print(tomllib.loads(pathlib.Path('pyproject.toml').read_text())['project']['version'])
          ")
          if git show HEAD^:pyproject.toml > /tmp/prev.toml 2>/dev/null; then
            old=$(python3 -c "
          import tomllib, pathlib
          print(tomllib.loads(pathlib.Path('/tmp/prev.toml').read_text())['project']['version'])
          ")
          else
            old=""
          fi
          echo "new=$new" >> "$GITHUB_OUTPUT"
          echo "old=$old" >> "$GITHUB_OUTPUT"
          if [ "$new" = "$old" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if version unchanged
        if: steps.v.outputs.changed != 'true'
        run: echo "Version unchanged; skipping release."

      - name: Set up uv
        if: steps.v.outputs.changed == 'true'
        uses: astral-sh/setup-uv@2bc602ff898ad0e7220b651a4a0f450b5ba2cd40 # v5

      - name: Build
        if: steps.v.outputs.changed == 'true'
        run: uv build

      - name: Create GitHub Release
        if: steps.v.outputs.changed == 'true'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ steps.v.outputs.new }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: dist/*

      - name: Publish to PyPI
        if: steps.v.outputs.changed == 'true'
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # release/v1
