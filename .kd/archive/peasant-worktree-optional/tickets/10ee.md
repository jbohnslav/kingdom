---
id: 10ee
status: open
deps: []
links: []
created: 2026-02-13T13:35:18Z
type: task
priority: 1
---
# Fix kd work integration issues from council review

Cursor implemented kd work and the peasant start refactor. Architecture is correct but has integration gaps: (1) 3 test failures in test_cli_peasant.py - mock launch_harness no longer exists, update to mock subprocess.Popen. (2) 7 test failures in test_council.py - council preamble injection changes expected prompt shapes. (3) kd work ignores --base flag - _resolve_peasant_context hardcodes Path.cwd(). (4) Duplicated Popen boilerplate - extract launch_work_background helper. (5) No thread seed in interactive kd work. (6) Dead code - remove harness.py main() and empty kd agent subcommand group.

## Worklog

- [13:42] Backend error: Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.

## PR #6 Review Findings

Collected from Codex, Claude, and Cursor Bugbot reviews.

### Critical / P1

1. **Worktree path inside repo** (`cli.py:870-904`) — `create_worktree()` places worktrees under `.kd/worktrees/`, which is inside the current git worktree. Git rejects nested worktrees. Place them outside the repo root.
2. **Message sequencing race** (`thread.py:202-259`) — `next_message_number()` + `add_message()` is non-atomic. Two processes can get same sequence number, losing messages. Use locking or `O_EXCL`.
3. **Backlog auto-move on read ops** (`cli.py:1003`) — `_resolve_peasant_context()` moves backlog tickets unconditionally, but is used by read-only commands (`peasant logs`, `peasant read`, `peasant stop`). Only auto-move in mutating commands.
4. **Missing worktree falls back to base** (`cli.py:1553`) — `peasant review --reject` silently falls back to `base` when worktree is missing, placing ticket changes on wrong branch. Fail explicitly instead.
5. **Council watch vs --to mismatch** (`cli.py:437`) — `council_watch` derives `expected_members` from thread metadata, not current ask target. `--to <member>` blocks until timeout waiting for all original members.
6. **Parallel --hand workers on same checkout** (`cli.py:1099`) — Existing-process guard only checks current ticket session. Two `--hand` workers can run against the same working tree, interleaving edits.

### High / P2

7. **Timezone-naive datetime crash** (`ticket.py:128-136`) — `parse_ticket()` uses `datetime.fromisoformat()` without handling naive datetimes. Mixed naive/aware datetimes in `list_tickets()` sort raises `TypeError`.
8. **Empty branch name from normalization** (`state.py:26-60`) — `normalize_branch_name()` can return empty string for non-ASCII input, causing state to write to `.kd/branches/` root.
9. **Council preamble mutating command** (`council/base.py:42`) — Preamble tells agents to run `kd design` which is mutating. Contradicts "Do NOT modify any other files" rule.
10. **Watch timeout boundary** (`cli.py:437`) — Watch uses same timeout as worker. Member finishing at boundary can be missed. Add buffer to watch timeout.
11. **Interactive `kd work` ignores --base** (`cli.py:1687`) — Missing internal args cause `worktree` to default to `Path.cwd()` even when `--base` is set. Changes applied to wrong checkout.
12. **$EDITOR with flags breaks ticket edit** (`cli.py:2331-2346`) — `[editor, file]` fails if `$EDITOR` includes flags like `code --wait`. Use `shlex.split(editor)`.
13. **Concurrent write collision in write_json** (`state.py:138-151`) — Only uses PID for temp name. Add random suffix or thread ID.

### Medium

14. **Codex workflow duplicate comments** (`.github/workflows/codex.yml`) — Uses `createComment` on every `synchronize`, spamming PRs. Use create-or-update pattern.
15. **Council watch expected_members on reused thread** (`cli.py:437`) — Reusing a thread from `--to codex` for an unscoped ask causes watch to stop after codex responds, silently dropping other member responses.

## Consensus Fixes (council review)

Original 6 integration gaps are resolved (88 tests pass). These remain:

### P1
- [ ] **Backlog auto-move on read ops** (#3) — Move auto-pull out of `_resolve_peasant_context`, only do it in `peasant_start` and `kd work`
- [ ] **Missing worktree falls back to base** (#4) — Fail explicitly in `peasant review --reject` when worktree is gone
- [ ] **Council watch vs --to mismatch** (#5/#15) — Pass expected members from current ask scope, not thread metadata
- [ ] **Parallel --hand workers on same checkout** (#6) — Block or warn when a second `--hand` worker launches against the same working tree

### P2
- [ ] **Message sequencing race** (#2) — Add `O_EXCL` or retry loop in `add_message` for council concurrent writes
- [ ] **Empty branch name** (#8) — Guard `normalize_branch_name` against empty result
- [ ] **Watch timeout buffer** (#10) — Add ~30s buffer to `council_watch` timeout
- [ ] **$EDITOR with flags** (#12) — Use `shlex.split(editor)` in ticket edit
- [ ] **Centralize worktree path resolution** (new, from Codex) — Worktree path logic duplicated in 3+ places (`cli.py:938`, `cli.py:1361`, `cli.py:1551`), centralize before other worktree fixes
- [ ] **find_ticket resolves across branches** (new, from Codex) — `_resolve_peasant_context` uses global `find_ticket` which can match tickets from wrong branch
