---
id: "fe84"
status: closed
deps: [b71d]
links: []
created: 2026-02-15T19:46:08Z
type: task
priority: 1
---
# File polling logic for stream files and finalized messages

## Context

Implement `poll.py` — the data-fetching layer that scans thread directories for changes. Reuses patterns from `watch_thread()` in `cli.py` but structured for the Textual async loop. The TUI calls this every 100ms.

## Acceptance Criteria

- [ ] `ThreadPoller` class tracks: last known message sequence, byte offsets per stream file, set of finalized members
- [ ] `poll()` method returns a list of update events: new finalized messages, stream text deltas, stream started, stream finished
- [ ] Detects new finalized message files (sequence > last known) by scanning `NNNN-*.md` files
- [ ] Tails `.stream-{member}.jsonl` files by byte offset, extracts text via `extract_stream_text()` (reuse existing backend-specific NDJSON extraction)
- [ ] Finalization signal is **message file exists**, not stream file deletion
- [ ] Detects stream file recreation (size < saved offset → reset) for retry handling
- [ ] Detects in-flight stream files from external processes (stream file exists but no TUI-launched query for that member)
- [ ] Unit tests covering: new message detection, stream tailing, finalization, retry/recreation
