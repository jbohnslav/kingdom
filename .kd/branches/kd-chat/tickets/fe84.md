---
id: "fe84"
status: closed
deps: [b71d]
links: []
created: 2026-02-15T19:46:08Z
type: task
priority: 1
---
# File polling logic for stream files and finalized messages

## Context

Implement `poll.py` — the data-fetching layer that scans thread directories for changes. Reuses patterns from `watch_thread()` in `cli.py` but structured for the Textual async loop. The TUI calls this every 100ms.

## Acceptance Criteria

- [ ] `ThreadPoller` class tracks: last known message sequence, byte offsets per stream file, set of finalized members
- [ ] `poll()` method returns a list of update events: new finalized messages, stream text deltas, stream started, stream finished
- [ ] Detects new finalized message files (sequence > last known) by scanning `NNNN-*.md` files
- [ ] Tails `.stream-{member}.jsonl` files by byte offset, extracts text via `extract_stream_text()` (reuse existing backend-specific NDJSON extraction)
- [ ] Finalization signal is **message file exists**, not stream file deletion
- [ ] Detects stream file recreation (size < saved offset → reset) for retry handling
- [ ] Detects in-flight stream files from external processes (stream file exists but no TUI-launched query for that member)
- [ ] Unit tests covering: new message detection, stream tailing, finalization, retry/recreation

## Worklog
- 2026-02-15: Reopened after council review (council-4a36). Multiple findings:
  - **`finalized_members` never resets across rounds.** `poll_messages()` adds member to `finalized_members` on finalization (line 117); `poll_streams()` skips members in that set (line 129). No reset between turns. If claude finalizes in round 1, all claude stream activity is ignored in round 2+. (All three members found this independently.)
  - **Fix options:** (a) If 16e1 fix adds stream file cleanup after query, `finalized_members` may be unnecessary — just remove the check since the file won't exist. (cursor) (b) Clear `finalized_members` when a new king message arrives / when stream file recreation is detected. (claude) (c) Reset `finalized_members` at the start of each poll cycle or when a new king message sequence is detected.
  - **Minor: `read_message_body()` duplicates `parse_message()` from thread.py.** poll.py also parses sender from filename (`stem.split("-", 1)`) rather than from `from:` frontmatter field. Two parsing paths that could diverge. Defensible for polling performance but worth noting. (claude)
- 2026-02-15: Fixed. Went with option (a) — removed `finalized_members` entirely. With 16e1's stream file cleanup, stream files are deleted after `run_query()` persists the response. No stale stream data to suppress. The finalization→new round lifecycle is: stream file deleted → message file written → poller sees finalized message → clears `active_streams` → new stream file appears → `StreamStarted` fires correctly. Added multi-turn test. Updated finalization tests to match real lifecycle (stream deleted before message written).
