---
id: "330b"
status: closed
deps: []
links: []
created: 2026-02-16T13:55:14Z
type: task
priority: 2
---
# Add kd chat debug mode to persist stream NDJSON files

## Context

`kd chat` currently deletes `.stream-{member}.jsonl` files after each query completes.
That keeps normal runs clean, but makes streaming/parsing bugs hard to diagnose because
the raw NDJSON event stream is gone after finalize.

Add an explicit debug mode to preserve stream files so we can inspect exact provider
events during live failures (for example Cursor partial-output behavior).

## Acceptance Criteria

- [x] Add an opt-in debug switch for `kd chat` (CLI flag and/or env var) to preserve per-member `.stream-*.jsonl`
- [x] Default behavior remains unchanged (stream files are cleaned up when debug mode is off)
- [x] Preserved debug stream files are easy to locate from thread directory and include member name
- [x] Add tests for cleanup vs preserve behavior in `run_query()`/poll flow
- [x] Document debug usage in ticket/worklog and/or chat docs (how to enable, where files land)

## Worklog

- 2026-02-16: Ticket created from live debugging need while investigating disappearing/overwritten-looking Cursor stream output in TUI.
- 2026-02-16: Added `kd chat --debug` flag and wired it into `ChatApp(debug_streams=True|False)`.
- 2026-02-16: Updated `run_query()` cleanup flow: when debug mode is on, `.stream-{member}.jsonl` is preserved as `.debug-stream-{member}-{timestamp}.jsonl` in the same thread directory, then live stream cleanup continues.
- 2026-02-16: Added tests:
  - `tests/test_tui.py::TestChatCommand::test_debug_streams_flag_passed_to_app`
  - `tests/test_tui.py::TestRunQuery::test_run_query_preserves_debug_stream_when_enabled`
- 2026-02-16: Verified with `uv run pytest tests/test_tui.py -q`, `uv run ruff check src/kingdom/cli.py src/kingdom/tui/app.py tests/test_tui.py`, and manual `uv run kd chat --help`.
- 2026-02-16: Debug usage: run `kd chat <thread-id> --debug` (or `kd chat --new --debug`). Files land under `.kd/branches/<branch>/threads/<thread-id>/.debug-stream-<member>-<timestamp>.jsonl`.
- 2026-02-16: Renamed debug flag from `--debug-streams` to `--debug` for shorter command usage.
- 2026-02-16: Full suite run (`uv run pytest -q`) is currently blocked by unrelated existing failure: `tests/test_config.py::TestValidateConfigErrors::test_council_auto_rounds_must_be_positive` (no `ValueError` raised).
