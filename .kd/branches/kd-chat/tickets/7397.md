---
id: "7397"
status: closed
deps: []
links: []
created: 2026-02-16T14:14:05Z
type: task
priority: 2
---
# Render thinking tokens in kd chat stream

## Context

Cursor stream JSON includes `thinking` events before assistant text, but `kd chat`
currently ignores them and only renders assistant text deltas. This makes Cursor
appear idle for long periods even though stream activity exists.

## Design

- **Config**: `chat.thinking_visibility: auto | show | hide` (default: `auto`)
- **`auto`**: stream thinking live, auto-collapse on first answer token into a one-line summary like `"▶ thinking · 1,247 chars · 4.2s"`. Click/Enter to re-expand.
- **`show`**: keep thinking expanded always.
- **`hide`**: drop thinking events (current behavior).
- **Widget**: Custom `ThinkingPanel`, not Textual `Collapsible`. Follows existing panel patterns. ~40-50 lines.
- **Key rules**: `user_pinned` flag — once user manually toggles, stop auto-collapsing. Autoscroll only if viewport is at bottom.
- **Stream layer**: Extend `extract_*_stream_text` to parse `thinking_delta` events; `ThreadPoller` emits `ThinkingDelta`.

## Acceptance Criteria

- [x] Implement `ThinkingPanel` widget with expanded/collapsed states
- [x] Add `council.thinking_visibility` config with `auto` (default), `show`, `hide` options
- [x] Implement `auto` behavior: expand on thinking start, collapse on answer start
- [x] Implement `user_pinned` logic: manual toggle overrides auto-collapse
- [x] Update stream parsing to handle `thinking` events and emit `ThinkingDelta`
- [x] Normal assistant output streaming still works and remains source of truth for finalized messages
- [x] Add tests covering all three visibility modes
- [x] Document the config key and visual behavior in ticket worklog

## Worklog

- 2026-02-16: Ticket created from live debug stream analysis (`council-72f2`) showing Cursor emits `thinking` events that are currently not rendered in TUI.
- 2026-02-16: Implemented thinking token rendering:
  - **Config**: `council.thinking_visibility` key (`auto`/`show`/`hide`, default `auto`) in `config.py`
  - **Stream parsing**: `extract_cursor_stream_thinking()` in `agent.py` parses `{"type":"thinking","subtype":"delta"}` events
  - **Poll layer**: `ThinkingDelta` event + `thinking_texts` tracking in `ThreadPoller` (parallel to existing `StreamDelta`)
  - **Widget**: `ThinkingPanel` in `widgets.py` — dashed border, expandable/collapsible, `user_pinned` flag, shows `▶ thinking · N chars · Xs` when collapsed
  - **App wiring**: `handle_thinking_delta()` mounts ThinkingPanel before StreamingPanel; `handle_stream_delta()` auto-collapses on first answer token (in `auto` mode); `hide` mode drops events entirely; cleanup on finalization/interrupt
  - **Tests**: 23 new tests — config validation (4), stream extraction (6), poll thinking events (5), tail_stream_file thinking (3), ThinkingPanel widget (5)
