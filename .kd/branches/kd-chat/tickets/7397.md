---
id: "7397"
status: closed
deps: []
links: []
created: 2026-02-16T14:14:05Z
type: task
priority: 2
---
# Render thinking tokens in kd chat stream

## Context

Cursor stream JSON includes `thinking` events before assistant text, but `kd chat`
currently ignores them and only renders assistant text deltas. This makes Cursor
appear idle for long periods even though stream activity exists.

## Design

- **Config**: `chat.thinking_visibility: auto | show | hide` (default: `auto`)
- **`auto`**: stream thinking live, auto-collapse on first answer token into a one-line summary like `"▶ thinking · 1,247 chars · 4.2s"`. Click/Enter to re-expand.
- **`show`**: keep thinking expanded always.
- **`hide`**: drop thinking events (current behavior).
- **Widget**: Custom `ThinkingPanel`, not Textual `Collapsible`. Follows existing panel patterns. ~40-50 lines.
- **Key rules**: `user_pinned` flag — once user manually toggles, stop auto-collapsing. Autoscroll only if viewport is at bottom.
- **Stream layer**: Extend `extract_*_stream_text` to parse `thinking_delta` events; `ThreadPoller` emits `ThinkingDelta`.

## Acceptance Criteria

- [x] Implement `ThinkingPanel` widget with expanded/collapsed states
- [x] Add `council.thinking_visibility` config with `auto` (default), `show`, `hide` options
- [x] Implement `auto` behavior: expand on thinking start, collapse on answer start
- [x] Implement `user_pinned` logic: manual toggle overrides auto-collapse
- [x] Update stream parsing to handle `thinking` events and emit `ThinkingDelta`
- [x] Normal assistant output streaming still works and remains source of truth for finalized messages
- [x] Add tests covering all three visibility modes
- [x] Document the config key and visual behavior in ticket worklog
- [x] Persist ThinkingPanel on finalization (collapse, don't remove)
- [x] Fix poll ordering: emit ThinkingDelta before StreamDelta in same batch
- [x] Add newline separators between Codex reasoning chunks
- [x] Fix Cursor assistant snapshot streaming (detect snapshots vs fragments)
- [x] Remove xfail from Cursor snapshot tests once fixed
- [x] Fix stream file timing race (don't delete stream files in run_query)
- [x] Clean up stale stream files on session startup (on_mount)
- [x] Codex thinking confirmed working (follow-up rounds fixed by panel ID archival)
- [x] Cursor thinking: not a code bug — Cursor (Gemini 3 Pro) doesn't emit thinking events

## Worklog

- 2026-02-16: Ticket created from live debug stream analysis (`council-72f2`) showing Cursor emits `thinking` events that are currently not rendered in TUI.
- 2026-02-16: Implemented thinking token rendering:
  - **Config**: `council.thinking_visibility` key (`auto`/`show`/`hide`, default `auto`) in `config.py`
  - **Stream parsing**: `extract_cursor_stream_thinking()` in `agent.py` parses `{"type":"thinking","subtype":"delta"}` events
  - **Poll layer**: `ThinkingDelta` event + `thinking_texts` tracking in `ThreadPoller` (parallel to existing `StreamDelta`)
  - **Widget**: `ThinkingPanel` in `widgets.py` — dashed border, expandable/collapsible, `user_pinned` flag, shows `▶ thinking · N chars · Xs` when collapsed
  - **App wiring**: `handle_thinking_delta()` mounts ThinkingPanel before StreamingPanel; `handle_stream_delta()` auto-collapses on first answer token (in `auto` mode); `hide` mode drops events entirely; cleanup on finalization/interrupt
  - **Tests**: 23 new tests — config validation (4), stream extraction (6), poll thinking events (5), tail_stream_file thinking (3), ThinkingPanel widget (5)
- 2026-02-16: Post-close validation findings from live `kd chat` run (`council-9428`) and debug stream inspection:
  - **Observed symptom**: screenshot showed no visible "thinking tokens" despite asking for explicit "think for 2 sentences before replying".
  - **Root cause 1 (backend coverage gap)**: thinking extraction is implemented only for Cursor `{"type":"thinking","subtype":"delta"}` events. Codex reasoning events (`item.completed` with `item.type="reasoning"`) are not extracted, and Claude has no thinking extractor path.
  - **Root cause 2 (event availability)**: Cursor does not emit `thinking` events on every prompt; some turns produce only assistant/result events, so no ThinkingPanel appears.
  - **Root cause 3 (visibility lifecycle mismatch)**: when finalized message arrives, `handle_new_message()` removes `thinking-*` panels along with waiting/streaming panels, so no collapsed summary remains after completion.
  - **Mismatch with ticket phrasing**: panel header currently reports character count (`N chars`) rather than true token counts.
  - **Follow-up scope needed**:
    - Add Codex reasoning extraction support (and decide whether/how Claude reasoning should be represented).
    - Preserve collapsed ThinkingPanel after finalize (instead of removing it with stream panels).
    - Clarify UI label to "thinking chars" or implement token accounting when provider usage data exists.
- 2026-02-16: Clarification after direct backend/event inspection:
  - **Current UI reality**: `kd chat` shows thinking only for Cursor. It does not currently render Codex or Claude reasoning/thinking.
  - **Codex**: stream includes `{"type":"item.completed","item":{"type":"reasoning","text":"..."}}` events (verified in debug stream artifacts), so Codex reasoning can be surfaced with parser support.
  - **Claude**: current `claude --output-format stream-json --include-partial-messages` path in this app emits text deltas and usage metadata, but no explicit thinking event type is parsed or rendered by `kd chat`.
  - **Implementation priority update**:
    - Immediate: add Codex `item.type=reasoning` extraction into ThinkingPanel flow.
    - Later: evaluate if Claude CLI can emit structured thinking events in this mode; if not, keep Claude as no-thinking in TUI and document that limitation.
- 2026-02-16: Follow-up implementation completed for Codex reasoning:
  - Added `extract_codex_stream_thinking()` in `agent.py` for `item.completed` + `item.type=reasoning` events.
  - Registered Codex in `STREAM_THINKING_EXTRACTORS`, so poller now emits `ThinkingDelta` for Codex.
  - Added tests in `tests/test_agent.py` and `tests/test_tui_poll.py` for Codex reasoning extraction and poll emission.
  - Verification: `uv run pytest tests/test_agent.py tests/test_tui_poll.py -q` passed (`112 passed, 2 xfailed`).
- 2026-02-16: **Reopened** after live testing revealed three remaining issues (confirmed by council-6980):
  - **Issue 1 — ThinkingPanel disappears on finalization**: `handle_new_message()` removes thinking panels along with wait/stream panels. The collapsed summary (`▶ thinking · N chars · Xs`) should persist above the finalized MessagePanel as a clickable widget.
  - **Issue 2 — Poll ordering bug**: `poll_streams()` emits `StreamDelta` before `ThinkingDelta` when both arrive in the same read batch. Auto-collapse fires on `StreamDelta` but the ThinkingPanel doesn't exist yet (no-op), then `ThinkingDelta` mounts an expanded panel that immediately gets removed by finalization. Fix: emit ThinkingDelta before StreamDelta.
  - **Issue 3 — Codex reasoning chunks lack line breaks**: `tail_stream_file()` joins thinking parts with `"".join()`, so multiple Codex reasoning blocks (separate `item.completed` events) smash together on one line. Should join with `"\n"`.
  - **Issue 4 — Cursor streaming broken**: Cursor `assistant` events are cumulative snapshots, not deltas. `extract_cursor_stream_text()` returns each snapshot as new text, which `tail_stream_file` concatenates — producing duplicated/garbled output. An xfail test already documents this (`test_cursor_assistant_snapshot_chunks_should_use_latest_snapshot`). The stream extractor needs snapshot-aware logic.
  - **Issue 5 — Cursor thinking tokens invisible in practice**: Combination of issues 2 and 4. Thinking events are extracted correctly but the panel never visibly renders due to poll ordering + rapid finalization.
  - **Keyboard toggle not implemented**: ThinkingPanel spec says "Click/Enter to re-expand" but `Static` is not focusable by default and no Enter key handler exists. (Lower priority — click works.)
- 2026-02-16: Implemented fixes for issues 1–5:
  - **`poll.py` — `merge_assistant_snapshots()`**: New helper detects Cursor cumulative snapshots (superset check) vs genuine new fragments. Used in both `tail_stream_file` (within-batch) and `poll_streams` (cross-batch accumulation).
  - **`poll.py` — `tail_stream_file()`**: Cursor text now uses `merge_assistant_snapshots()` instead of `"".join()`. Codex thinking now uses `"\n".join()` for line breaks between reasoning blocks.
  - **`poll.py` — `poll_streams()`**: Reordered event emission — `ThinkingDelta` emitted before `StreamDelta` so ThinkingPanel exists when auto-collapse fires. Cross-batch Cursor accumulation uses `merge_assistant_snapshots([prev, new_text])` instead of concatenation.
  - **`app.py` — `remove_member_panels()`**: Removed `"thinking"` from prefix list so ThinkingPanel survives follow-up rounds.
  - **Tests**: Removed xfail from `test_cursor_assistant_snapshot_chunks_should_use_latest_snapshot`. Added 10 new tests: `TestMergeAssistantSnapshots` (5), `TestCursorCrossBatchSnapshot` (1), `TestCodexThinkingNewlines` (2), poll ordering (1), import of `merge_assistant_snapshots` (1).
  - **Verification**: 831 passed, 3 skipped, 1 xfailed (the remaining xfail is `test_ndjson_short_result_should_not_overwrite_richer_assistant_stream` in `test_agent.py` — about `parse_cursor_response` final response parser, not streaming).
- 2026-02-16: **Live testing findings** — two issues remain:
  - **Codex thinking only on first message**: ThinkingPanel appears for Codex on the initial broadcast round but not on follow-up sequential rounds. Likely cause: `remove_member_panels` fix preserves the ThinkingPanel, but something in the follow-up round lifecycle (stream file recreation, poller state reset, or panel ID collision) prevents new thinking from appearing.
  - **Cursor thinking still invisible**: Despite snapshot merge fix and poll ordering fix, Cursor thinking tokens are not rendering in live testing. Cursor may not be emitting `{"type":"thinking","subtype":"delta"}` events in all modes, or the events may be arriving after the stream file is already deleted on finalization.
  - **Codex thinking line breaks not working**: Screenshot shows collapsed ThinkingPanel with 226 chars / 27.4s. Content reads `**Planning ticket retrieval using kd CLI****Planning root-cause inspection****Correcting repository path assumption****Targeting test directory search****Investigating panel update logic****Investigating member panel removal**` — all reasoning blocks smashed together with no line breaks, just `****` where one bold block ends and the next begins. The `"\n".join()` fix in `tail_stream_file` is not taking effect. Likely cause: each Codex reasoning `item.completed` event arrives in a separate poll batch (separate NDJSON line appended between poll cycles), so `tail_stream_file` only ever sees one `thinking_part` per call. The newline join only helps when multiple reasoning events land in the same batch. The cross-batch accumulation in `poll_streams` still uses plain `+` concatenation for thinking text (`accumulated_thinking = self.thinking_texts.get(member, "") + new_thinking`), which is where the separator needs to be added.
- 2026-02-16: Cursor applied fixes directly to source files during `kd chat` despite preamble saying "Do NOT create, edit, or write files." The fixes themselves are correct:
  - **`poll.py` — poll ordering**: `poll()` now runs `poll_streams()` before `poll_messages()` so the last thinking chunk is captured before finalization clears state.
  - **`poll.py` — lifecycle cleanup**: `poll_messages()` no longer clears stream state (`active_streams.discard`, `stream_offsets.pop`, etc). Cleanup moved to end of `poll_streams()` using `found_members` set — state only cleared when the stream file is physically gone.
  - **`app.py` — panel ID archival**: On finalization, `handle_new_message()` renames the ThinkingPanel ID to `thinking-{sender}-{sequence}` so the next round creates a fresh panel instead of reusing the collapsed one.
  - **Compliance issue**: Cursor ignoring "do not edit files" instruction in chat preamble is a known problem. Need stronger guardrails (e.g. `skip_permissions=False` for chat mode, or removing write tools from Cursor's chat config).
- 2026-02-16: Council thread `council-b61c` — root cause analysis from all three members:
  - **Claude's analysis** (2 root causes):
    1. Codex follow-ups: collapsed ThinkingPanel from round 1 is reused by `handle_thinking_delta` (finds old panel via `query_one`), updates its text, but never re-expands it. The panel ID archival fix addresses this.
    2. Cursor thinking invisible: extractor expects `{"type":"thinking","subtype":"delta"}` but Cursor may emit `thinking_delta` inside `stream_event` wrapper (like text deltas), e.g. `{"type":"stream_event","event":{"type":"content_block_delta","delta":{"type":"thinking_delta","thinking":"..."}}}`. Need `--debug-streams` capture to confirm actual event shape.
  - **Codex's analysis** (4 causes):
    1. Backend/event shape mismatch — only Cursor+Codex have extractors; Cursor's expected shape may not match reality.
    2. Panel keyed by `thinking-{name}` reused globally, not per-round (addressed by ID archival fix).
    3. `update_thinking()` in ThinkingPanel only redraws when expanded — collapsed panel silently absorbs updates (need to check `widgets.py`).
    4. Poll timing race — `poll_messages` ran before `poll_streams`, fast responses finish before 100ms poll sees thinking (addressed by poll reorder fix).
  - **Cursor's analysis** (3 causes, stalled ~4min before responding):
    1. Poll order race — same as Codex #4, addressed.
    2. Panel ID collision — same as Codex #2, addressed.
    3. "Ghost" streams — `poll_messages` clearing state while stream file still exists caused next `poll_streams` to see offset-0 "new" stream. Addressed by moving cleanup to `poll_streams`.
    - **Note**: Cursor applied these fixes directly to source files during the chat session, violating the preamble instruction "Do NOT create, edit, or write files." The fixes are correct but the behavior is a compliance problem — Cursor should advise, not act.
  - **Remaining fixes needed**:
    1. Cross-batch Codex thinking newline: `poll_streams` line `accumulated_thinking = prev_thinking + new_thinking` needs `"\n"` separator for codex backend. **Fixed** — added `"\n"` separator when `prev_thinking` exists and `backend == "codex"`.
    2. Cursor thinking event shape: see below.
- 2026-02-16: Added 19 new poller tests across 5 test classes covering cross-batch behavior, multi-round lifecycle, event ordering, cleanup, and snapshot edge cases.
- 2026-02-16: **Root cause CORRECTED for Cursor thinking invisibility** (previous hypothesis about event shape was wrong):
  - Examined real Cursor debug streams from `council-72f2` (3 captures). Cursor DOES emit top-level `{"type":"thinking","subtype":"delta","text":"..."}` — exactly the format our extractor expects. The `stream_event` wrapper hypothesis was incorrect.
  - `extract_cursor_stream_thinking()` correctly parses the real event format. Tests using real NDJSON snippets from the debug streams all pass at the extraction and poller layers.
  - **Real root cause: timing race**. Fast Cursor responses (~7.7s for "hi") complete between poll cycles. `run_query` (`app.py:363`) deletes the stream file immediately after the subprocess exits. If the entire response (thinking + text + result) is written and the file deleted before the poller's 100ms tick, the poller never sees the stream file and no ThinkingDelta is emitted. A failing test (`test_cursor_fast_response_stream_deleted_before_poll`) now documents this.
  - **Additional findings from debug streams**:
    - Cursor assistant events are fragments (NOT cumulative snapshots as assumed), with a final cumulative snapshot at the end. `merge_assistant_snapshots` handles this correctly because non-overlapping fragments fall through to the append branch.
    - Cursor emits `thinking.completed` events between tool call rounds, with new `thinking.delta` events after tool rejections. Multiple thinking rounds accumulate correctly in the poller.
    - Second debug stream (interrupted response) has only `system` + `user` lines — no thinking emitted at all. This is expected for interrupted/timed-out responses.
  - **Secondary factor**: Cursor doesn't emit thinking on every prompt (model/mode dependent), so even correct parsing won't guarantee visibility on every turn.
  - **Fix needed**: `run_query` should not delete the stream file before the poller has had a chance to read final data. Options: (a) delay deletion until after a poll cycle, (b) read and cache final stream data before deleting, (c) keep the stream file and let poller cleanup handle it.
- 2026-02-16: Test suite: 69 tests in test_tui_poll.py (68 pass, 1 fail documenting the timing race).
- 2026-02-16: Council thread `council-7355` — all three members confirmed the timing race root cause and agreed on minimal fix: stop deleting stream files in `run_query`, clean up stale files on session startup.
- 2026-02-16: **Implemented timing race fix**:
  - **`app.py` — `run_query`**: Removed `stream_path.unlink()` from `finally` block. Stream files now persist for the poller to drain.
  - **`app.py` — `on_mount`**: Added cleanup of stale `.stream-*.jsonl` files on session startup to prevent ghost streams on restart (Cursor's suggestion from council-7355).
  - **Tests**: Updated `test_run_query_cleans_up_stream_file` → `test_run_query_preserves_stream_file` (asserts file persists). Updated `test_cursor_fast_response_stream_deleted_before_poll` → `test_cursor_fast_response_stream_persists_for_poll` (now passes — race is fixed).
  - **Verification**: 860 passed, 3 skipped, 1 xfailed.
- 2026-02-16: Council thread `council-82f8` — live testing confirmed thinking works for Codex (reasoning events visible in ThinkingPanel). Cursor (Gemini 3 Pro) does not emit `{"type":"thinking","subtype":"delta"}` events — zero thinking events across three rounds. This is a model/backend limitation, not a code bug. Claude also doesn't emit thinking events in stream-json mode. Reverted unauthorized Cursor edit to `poll.py` (text→binary mode in `tail_stream_file`).
- 2026-02-16: **Cursor compliance issue (recurring)**: Cursor edited `poll.py` and created `reproduce_issue.py` during `council-82f8` chat despite preamble instruction. Second occurrence — need stronger guardrails (backlog ticket).
