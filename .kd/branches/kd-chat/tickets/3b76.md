---
id: "3b76"
status: closed
deps: [16e1, 213e, 8ea4]
links: []
created: 2026-02-15T19:46:12Z
type: task
priority: 2
---
# Auto-turn round-robin scheduler

## Context

After the initial broadcast round in `kd chat`, councillors can enter auto-mode: sequential round-robin, one member at a time, up to N messages before waiting for the king. Uses thread history injection for each turn. Respects `/mute`, `@member`, and Escape interrupt.

## Design (v2 — council-d0c7)

### Conversation flow

1. **First king message** → broadcast (parallel) → stop, wait for king. No auto-turns — the first exchange is just gathering initial positions.
2. **Follow-up king messages** → broadcast (parallel) → then round-robin up to N sequential messages → stop, wait for king.
3. **@member** → directed to that member only, no auto-turns.
4. **@all on follow-up** → explicit broadcast + auto-turns, same as follow-up behavior.

### Budget

- Budget is **N messages total** (not rounds). Rename `auto_rounds` → `auto_messages`.
- Default N = `len(unmuted_members)` — each member speaks once per king turn.
- `auto_messages: 0` in config disables auto-turns entirely.
- Failed/timed-out attempts consume budget (predictable, prevents churn).

### First-message detection

Infer from thread history: if no prior member responses exist, it's the first message → skip auto-turns. One `list_messages()` call at top of `run_chat_round()`. No new state needed.

### @mention override

- King @mentions work today (directed message, single target).
- LLM-to-LLM @mentions (parsing response text, reordering queue) deferred — file backlog ticket.

## Acceptance Criteria

- [x] Broadcast (parallel) on every king message to all/unmuted members
- [x] Round-robin order follows `council.members` list order
- [x] Each auto-turn: build prompt via `format_thread_history()`, query one member
- [x] Sequential within auto-turns — one member at a time
- [x] **Rename `auto_rounds` → `auto_messages`** in config, Council, validation
- [x] **Budget is messages, not rounds** — single counter loop in `run_chat_round`
- [x] **First king message: no auto-turns** — infer from thread history
- [x] **Follow-up king messages: auto-turns up to N messages** (default len(members))
- [x] `/mute`-ed members skipped in round-robin (per-member check)
- [x] `@member` directed messages skip auto-turns
- [x] Escape interrupt stops auto-turns
- [x] New king message preempts current generation (generation counter)
- [x] Errors/timeouts: skip that member, continue with remaining budget
- [x] `council.mode: "sequential"` for sequential initial round instead of parallel
- [x] WaitingPanel ID collision fixed (remove stale panels before mount)
- [x] Dead `prompt` parameter removed from `run_query()`

## Work Log

### Implementation (v1)

**`src/kingdom/council/council.py`** — Added `auto_rounds: int = 3` and `mode: str = "broadcast"` fields to `Council` dataclass. Updated `Council.create()` to pass these from config.

**`src/kingdom/config.py`** — Changed `auto_rounds` validation from `> 0` to `>= 0` to allow disabling auto-turns with `auto_rounds: 0`.

**`src/kingdom/tui/app.py`** — Core changes:
- Added `self.generation: int = 0` counter for user message preemption detection
- Refactored `send_message()`: broadcast messages (`to == "all"`) launch `run_chat_round()` coordinator; directed messages launch single `run_query()` with no auto-turns
- Added `run_chat_round(targets, generation, tdir)` coordinator
- Added `remove_member_panels()` helper to prevent WaitingPanel ID collisions

### Council Review (council-72f2) — v1 fixes

- [x] WaitingPanel ID collision
- [x] Concurrent generation overlap
- [x] Mute check per-member
- [x] Dead `prompt` parameter
- [x] AC wording

### Redesign (council-d0c7) — v2

King feedback: "I just said hi and got 6 messages." Auto-turns firing after initial broadcast is too aggressive. Council consensus:
- Rename `auto_rounds` → `auto_messages`, budget is messages not rounds
- First message: broadcast only, no auto-turns
- Follow-ups: broadcast + N sequential messages (default len(members))
- Defer LLM-to-LLM @mentions to backlog
