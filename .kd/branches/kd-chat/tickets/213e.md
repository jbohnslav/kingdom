---
id: "213e"
status: closed
deps: []
links: []
created: 2026-02-15T19:46:12Z
type: task
priority: 2
---
# Thread history injection: format_thread_history()

## Context

Build `format_thread_history()` function that constructs a multi-party conversation prompt from thread messages. Used by auto-turn scheduler to give each agent full cross-agent awareness. No session resume (`--resume`) — thread history is the only context source.

## Acceptance Criteria

- [x] `format_thread_history(thread_dir, target_member)` reads all finalized messages in sequence order
- [x] Output format: `[Previous conversation]\nking: ...\n\nclaude: ...\n\n---\nYou are {target_member}. Continue the discussion.`
- [x] History block contains message bodies only — no preambles, frontmatter, or instructions
- [x] Each member identified by `from` field from message frontmatter
- [x] Preamble (safety + phase + agent prompts) prepended before history block by caller
- [x] Full thread history included (no truncation) — human manages context boundaries
- [x] Unit tests: empty thread, single message, multi-member conversation, directed @member messages

## Worklog

- Council consulted (council-f43a): 2-1 split on placement (thread.py vs council/history.py). Went with thread.py — pure function over thread data, same layer as list_messages().
- All three agreed: don't strip markdown, include all messages (full visibility), body verbatim.
- Added optional `suffix` parameter per claude's suggestion for caller flexibility.
- Directed messages annotated with `(to target)` only when target is a specific member (not "all"/"king"), keeping normal response flow clean.
- 7 unit tests: empty, single, multi-member, directed, broadcast, custom suffix, multiline body.
