---
id: "213e"
status: open
deps: []
links: []
created: 2026-02-15T19:46:12Z
type: task
priority: 2
---
# Thread history injection: format_thread_history()

## Context

Build `format_thread_history()` function that constructs a multi-party conversation prompt from thread messages. Used by auto-turn scheduler to give each agent full cross-agent awareness. No session resume (`--resume`) — thread history is the only context source.

## Follow-up Scope (Cursor Weirdness)

Live `kd chat` runs exposed behavior that conflicts with the "thread history only" intent:

- Cursor sometimes answers with council/meta framing (for example "Council Advisor") instead of normal in-thread recall.
- Persisted message bodies may include duplicated speaker prefixes (for example `codex: codex: ...`), which pollutes future history turns.
- Existing per-agent resume state may leak context into new chat threads, causing non-thread context to appear.

## Acceptance Criteria

- [x] `format_thread_history(thread_dir, target_member)` reads all finalized messages in sequence order
- [x] Output format: `[Previous conversation]\nking: ...\n\nclaude: ...\n\n---\nYou are {target_member}. Continue the discussion.`
- [x] History block contains message bodies only — no preambles, frontmatter, or instructions
- [x] Each member identified by `from` field from message frontmatter
- [x] Preamble (safety + phase + agent prompts) prepended before history block by caller
- [x] Full thread history included (no truncation) — human manages context boundaries
- [x] Unit tests: empty thread, single message, multi-member conversation, directed @member messages
- [x] Chat caller path enforces "thread history only" context for new threads (no unrelated resume/session leakage)
- [x] Response persistence strips accidental leading `<agent>:` label duplication before writing message body
- [x] Regression coverage reproduces and prevents Cursor meta-response contamination loop in multi-turn chat

## Worklog

- Council consulted (council-f43a): 2-1 split on placement (thread.py vs council/history.py). Went with thread.py — pure function over thread data, same layer as list_messages().
- All three agreed: don't strip markdown, include all messages (full visibility), body verbatim.
- Added optional `suffix` parameter per claude's suggestion for caller flexibility.
- Directed messages annotated with `(to target)` only when target is a specific member (not "all"/"king"), keeping normal response flow clean.
- 7 unit tests: empty, single, multi-member, directed, broadcast, custom suffix, multiline body.
- Reopened on 2026-02-16 after observing Cursor/cross-agent oddness in `council-9cb6` (notably `0004-cursor.md`, `0007-cursor.md`) and speaker-prefix duplication in Codex outputs.
- Fixed three bugs:
  1. Session isolation: removed `council.load_sessions()` from `ChatApp.on_mount()` — chat threads use `format_thread_history()` for context, not session resume IDs.
  2. Speaker prefix stripping: `AgentResponse.thread_body()` now strips leading `{name}: ` prefix that agents echo back from history format, preventing `codex: codex: ...` duplication.
  3. Chat preamble: added `CHAT_PREAMBLE` in `tui/app.py` and `preamble` field on `CouncilMember` — chat members get conversational framing instead of "council advisor" framing that triggered Cursor meta-responses.
- Tests: 5 new tests (prefix strip, no false strip, no cross-speaker strip, preamble override default, preamble override custom) + 2 TUI tests (session isolation, chat preamble). Full suite 742 pass.
