---
id: "a6a6"
status: closed
deps: []
links: []
created: 2026-02-16T13:25:21Z
type: task
priority: 2
---
# Enable Cursor partial stream output in kd chat

## Context

`kd chat` requests streaming for all members, but Cursor currently may emit little/no incremental text during a run. This makes `StreamingPanel` appear stagnant for Cursor compared with Claude/Codex.

Cursor CLI exposes `--stream-partial-output` for `--print --output-format stream-json` mode. We should explicitly use it in our Cursor command builder for streaming queries.

## Acceptance Criteria

- [x] `build_cursor_command(..., streaming=True)` adds `--stream-partial-output`
- [x] `build_cursor_command(..., streaming=False)` does not add `--stream-partial-output`
- [x] Existing Cursor command semantics remain unchanged (`--mode ask`, model, resume, extra flags)
- [x] TUI behavior verified manually: Cursor panel receives incremental stream deltas during active response (not only final message jump)
- [x] Tests added/updated for command construction behavior

## Worklog

- 2026-02-16: Ticket opened after dogfooding `kd chat` and observing weak/non-incremental Cursor streaming despite active stream lifecycle.
- 2026-02-16: Research sweep:
  - Official Cursor output-format docs confirm `stream-json` NDJSON event stream and assistant text reconstruction model: https://docs.cursor.com/en/cli/reference/output-format
  - Official Cursor CLI usage/headless docs confirm `--print` scripting path used by `kd`: https://docs.cursor.com/en/cli/using and https://docs.cursor.com/en/cli/headless
  - Local CLI help (current installed `agent`) lists `--stream-partial-output` for `--print --output-format stream-json`.
  - External wrappers/examples also pass `--stream-partial-output`:
    - https://pypi.org/project/cursor-cli/ (links to `veictry/cursor-cli`)
    - https://docs.praison.ai/docs/code/cursor-cli
- 2026-02-16: Implemented `--stream-partial-output` in `build_cursor_command()` when `streaming=True`.
- 2026-02-16: Added/updated tests in `tests/test_agent.py` for Cursor streaming flag presence/absence.
- 2026-02-16: Validation: `uv run pytest tests/test_agent.py -q` (70 passed), `uv run ruff check src/kingdom/agent.py tests/test_agent.py`.
- 2026-02-16: Reproduced truncation in live thread `council-082d` (`0006-cursor.md` and `0008-cursor.md` cut mid-sentence).
- 2026-02-16: Root cause: with `--stream-partial-output`, Cursor emits multiple `assistant` chunk events; parser previously kept only the first assistant chunk when no deltas were present.
- 2026-02-16: Fixed `parse_cursor_response()` to prioritize `result` text, preserve delta preference, and merge assistant chunks when result is absent.
- 2026-02-16: Extended `extract_cursor_stream_text()` to read `assistant` chunk events for stream polling.
- 2026-02-16: Added regression tests for assistant chunk parsing and extraction (`tests/test_agent.py`).
- 2026-02-16: Validation: `uv run pytest tests/test_agent.py -q` (74 passed), `uv run pytest tests/test_tui_poll.py -q` (20 passed), `uv run ruff check src/kingdom/agent.py tests/test_agent.py`.
- 2026-02-16: Added `xfail` regression for short final `result` clobbering richer streamed assistant text (`tests/test_agent.py::TestParseCursorResponseNDJSON::test_ndjson_short_result_should_not_overwrite_richer_assistant_stream`).
- 2026-02-16: Added `xfail` regression for Cursor cumulative assistant snapshots in poller (`tests/test_tui_poll.py::TestThreadPollerStreaming::test_cursor_assistant_snapshot_chunks_should_use_latest_snapshot`).
- 2026-02-16: Manual verification: `agent --print --output-format stream-json --stream-partial-output` confirmed emitting incremental `assistant` chunks. Parser and poller handle them correctly per automated tests. Stream polling extracts text from assistant events via `extract_cursor_stream_text()`.
