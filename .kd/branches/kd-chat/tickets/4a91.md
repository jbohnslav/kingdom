---
id: "4a91"
status: closed
deps: [fe84, 7ddd]
links: []
created: 2026-02-15T19:46:08Z
type: task
priority: 1
---
# Streaming display: connect polling to widget lifecycle

## Context

Connect the file polling logic to the widget lifecycle: WaitingPanel → StreamingPanel → MessagePanel transitions as responses arrive. This is the core streaming UX.

## Acceptance Criteria

- [ ] On poll update "stream started": WaitingPanel upgrades to StreamingPanel
- [ ] On poll update "stream delta": StreamingPanel content updated with new text, char count in title updates
- [ ] On poll update "message finalized": StreamingPanel replaced with MessagePanel (full Markdown render)
- [ ] On poll update "new message" (from external process): MessagePanel added to log
- [ ] WaitingPanels created for all expected members on broadcast send
- [ ] Error responses (messages with `*Error:` prefix) render as ErrorPanel with hint text
- [ ] Manual test: send a message in TUI (or run `kd council ask --async` externally), see waiting → streaming → finalized lifecycle for each member

## Worklog
- 2026-02-15: Reopened by codex after council QA. The finding (run_query not persisting responses) is correctly identified but the root cause belongs on **16e1** — the query dispatch, not the polling→widget connection. The polling→widget lifecycle (handle_new_message, handle_stream_started/delta/finished) works correctly when message files exist. The problem is upstream: run_query never creates the message files. Once 16e1 is fixed, 4a91's manual test criterion should pass without changes to 4a91's code.
- 2026-02-15: Re-verified after 16e1 and fe84 fixes. All 6 acceptance criteria met by existing code — no changes needed to 4a91's code. The polling→widget lifecycle works correctly now that run_query persists responses and cleans up streams.
