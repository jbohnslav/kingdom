---
id: "0f27"
status: closed
deps: []
links: []
created: 2026-02-16T14:20:02Z
type: task
priority: 2
---
# Fix cross-talk between kd chat and concurrent agent workflows

## Context

When `kd chat` is open while other agent workflows are running (`kd council ask`,
harness/worker runs), member behavior can bleed across contexts ("cross-talk"):
persona/prompt behavior and session continuity can appear inconsistent with the
active chat thread.

Observed in branch `kd-chat` during live dogfooding:
- chat thread stream/debug files showed one Cursor session lineage
- branch session state later pointed to a different Cursor resume/session lineage
- concurrent non-chat flows were active and updating per-agent state

We need explicit context/session isolation so chat conversations do not leak into
or inherit from other agent lanes.

## Acceptance Criteria

- [x] Reproduce cross-talk with an automated test or deterministic fixture (chat + concurrent non-chat flow)
- [x] Define and implement session isolation boundaries for chat vs non-chat workflows
- [x] Ensure chat cannot accidentally inherit/continue council/harness session context
- [x] Ensure non-chat workflows cannot clobber active chat session context
- [x] Add regression tests for the isolation rules
- [x] Document expected isolation behavior and operational debugging steps in worklog/docs

## Worklog

- 2026-02-16: Ticket created from live report: cross-talk when `kd chat` runs concurrently with other agent workflows.
- 2026-02-16: Initial evidence captured: `council-72f2` debug stream session IDs for Cursor differed from current branch `sessions/cursor.json` resume lineage during concurrent activity.
- 2026-02-16: Council review (council-4583). Consensus: "chat is stateless" — two surgical fixes in `app.py`.
- 2026-02-16: Root cause: two cross-talk vectors in `app.py`:
  1. `on_mount` set `member.base`/`member.branch`, causing `query_once()` to write chat PIDs to shared `sessions/{agent}.json` files.
  2. `query_once()` accumulated `session_id` in memory across turns, leaking `--resume` context between chat queries.
- 2026-02-16: Fix applied:
  1. Removed `member.base = self.base` / `member.branch = self.branch` from `on_mount()` — chat no longer writes PIDs to shared session files.
  2. Added `member.session_id = None` in `run_query()` finally block — prevents `--resume` leaking across chat turns.
- 2026-02-16: Isolation model: chat is fully stateless. Context comes from `format_thread_history()` only. No `load_sessions()`, no `save_sessions()`, no PID tracking, no `--resume`. Non-chat workflows (council ask, peasant) continue using branch-level `sessions/{agent}.json` unchanged.
- 2026-02-16: Three regression tests added in `TestChatSessionIsolation`:
  - `test_on_mount_does_not_set_member_base_branch` — verifies base/branch stay None
  - `test_chat_clears_session_id_after_query` — verifies session_id reset after each query
  - `test_chat_query_does_not_pass_session_id` — verifies second query doesn't inherit first query's session
