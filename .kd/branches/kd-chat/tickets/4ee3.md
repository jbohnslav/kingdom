---
id: "4ee3"
status: closed
deps: []
links: []
created: 2026-02-16T19:04:25Z
type: bug
priority: 2
---
# kd chat: label interrupted partial messages so they aren't mistaken as complete

When a `kd chat` response is interrupted mid-stream, the resulting visible message should be clearly labeled as interrupted/incomplete so it is not mistaken for a full final answer later.

Repro:
1. Start a chat response that is actively streaming.
2. Interrupt it before completion.
3. Re-open/read thread history later.

Current pain:
- Partial text can look like a normal completed response.

Expected:
- Interrupted responses display an explicit marker at the bottom (for example: "[Interrupted]") in both live TUI view and when revisiting the thread.
- Label should be visually distinct from normal completion and timeout/error states.

Acceptance criteria:
- Interrupting an in-flight response produces a persisted interrupted/incomplete indicator.
- TUI message rendering shows the interrupted marker on replay/history, not only live stream.
- Normal completed responses remain unlabeled.
- Add automated tests for interrupted vs complete rendering.

## Design

- `thread.py`: Add `is_interrupted_response()` detection — looks for `*[Interrupted` marker in body
- `app.py` `run_query()`: When `self.interrupted` and `response.text` is non-empty, append `"\n\n*[Interrupted — response may be incomplete]*"` to persisted body
- `app.py` `load_history()` and `handle_new_message()`: Check `is_interrupted_response()` alongside `is_error_response()` to render interrupted messages as `ErrorPanel` (red border, "errored" label)

## Acceptance Criteria

- [x] Interrupting an in-flight response produces a persisted interrupted/incomplete indicator
- [x] TUI message rendering shows the interrupted marker on replay/history, not only live stream
- [x] Normal completed responses remain unlabeled
- [x] Automated tests for interrupted vs complete rendering (unit + integration)
- [x] Full test suite passes (887 passed)

## Worklog

- 2026-02-16: Implemented fix in 3 files:
  - `thread.py`: Added `is_interrupted_response()` — detects `*[Interrupted` marker
  - `app.py` `run_query()`: Appends `*[Interrupted — response may be incomplete]*` to partial text when interrupted
  - `app.py` `load_history()` + `handle_new_message()`: Detect interrupted messages → render as `ErrorPanel`
  - Unit test: `test_run_query_labels_interrupted_partial_response` (updated existing test too)
  - Integration tests: `TestInterruptedLabel` (2 tests — interrupted renders as ErrorPanel, normal stays MessagePanel)
  - 887 passed, 3 skipped, 1 xfailed

Notes:
- Related to interrupt handling ticket `d869` and message metadata ticket `9124`.
