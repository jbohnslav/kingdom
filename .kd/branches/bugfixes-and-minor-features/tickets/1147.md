---
id: "1147"
status: closed
deps: []
links: []
created: 2026-02-14T04:49:09Z
type: bug
priority: 1
---
# Peasant --hand mode exits immediately without doing work

`kd peasant start 98f3 --hand` appeared to complete instantly (1 iteration, 148 bytes of log output). The harness called claude with `--print` which just prints and exits — no interactive agent loop. The peasant reported "working" status but made no code changes. Possibly the `--hand` flag causes a different code path that doesn't actually run the agent loop properly.

**Observed:** Peasant logs show one iteration, calls backend with `--dangerously-skip-permissions --print`, exits immediately.

**Expected:** Peasant should run a full agent loop — read the ticket, investigate the code, make changes, run tests.

**Possibly related:** May only affect `--hand` mode (serial, current dir). Worktree mode untested.

## Resolution

The `--print` flag is correct — the harness manages the loop, not claude. The actual issue: if the agent reports `STATUS: DONE` prematurely (first iteration, no code changes), quality gates pass trivially (nothing changed = clean state) and the loop exits after 1 iteration.

**Fix:** Added a "no-progress guard" in the harness. Before accepting `STATUS: DONE`, the harness checks for actual code changes (uncommitted changes via `git status --porcelain` + committed changes via `git log start_sha..HEAD`). If no changes exist, the DONE is rejected and the agent is told to keep working.

Changes:
- `harness.py`: Added `has_code_changes()` helper + guard before quality gates in the DONE handler
- `test_harness.py`: Added `TestHasCodeChanges` unit tests (5 cases) + integration test for the rejection path; updated existing tests to mock the new guard

## Worklog

- 2026-02-20 — Added no-progress guard: reject DONE when no code changes detected. Full test suite green (1168 passed).
