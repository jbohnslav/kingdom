---
id: "c6b2"
status: in_progress
deps: []
links: []
created: 2026-02-20T15:06:24Z
type: task
priority: 1
---
# Pythonic deslop

Run the pythonic-deslop style guide across the kingdom codebase. Clean up AI-generated slop: unnecessary abstractions, over-engineered patterns, verbose comments, underscore-prefixed functions, and anything that violates the project's style rules in CLAUDE.md.

## Acceptance Criteria

- [ ] Full codebase pass with /pythonic-deslop skill
- [ ] No underscore-prefixed private functions
- [ ] Unnecessary abstractions and over-engineering removed
- [ ] Ruff clean (`ruff check --fix --unsafe-fixes .`)
- [ ] Full test suite green after changes

## Findings

### Underscore-prefixed functions (CLAUDE.md violation)
1. **session.py:153** — `_apply` closure in `update_agent_state`
2. **session.py:241** — `_apply` closure in `set_current_thread`
3. **cli.py:3206** — `apply_status_filter` nested function (not underscore, but local def that could be extracted)

### Docstring parroting (restating what's obvious from name+sig)
1. **parsing.py:14-28** — `parse_yaml_value` docstring repeats "Parse a single YAML value" then lists Args/Returns for a trivial function
2. **parsing.py:60-68** — `serialize_yaml_value` docstring — pure restatement
3. **parsing.py:88-103** — `parse_frontmatter` docstring is fine (explains format contract)
4. **ticket.py:57-65** — `clamp_priority` docstring restates the function name; Args/Returns unnecessary for a 6-line function
5. **ticket.py:75-83** — `generate_ticket_id` docstring is fine
6. **ticket.py:103-115** — `coerce_to_str_list` docstring — the name + type sig tell the story, paragraph is noise
7. **ticket.py:124-134** — `parse_ticket` docstring — "Parse ticket content from YAML frontmatter" is the function name
8. **ticket.py:183-190** — `serialize_ticket` docstring — obvious from name
9. **ticket.py:229-240** — `read_ticket` / `write_ticket` docstrings — obvious
10. **ticket.py:261-269** — `list_tickets` docstring — the sort order comment is useful, the rest is noise
11. **ticket.py:288-297** — `collect_all_tickets` docstring — fine, describes non-obvious behavior (skips done branches)
12. **ticket.py:466-478** — `move_ticket` docstring — obvious
13. **ticket.py:495-512** — `append_worklog_entry` docstring is borderline; the format detail is useful
14. **ticket.py:567-579** — `get_ticket_location` docstring — restates the 3-line function
15. **breakdown.py** — all docstrings are fine (short templates)
16. **design.py** — docstrings are fine
17. **thread.py** — many docstrings restate obvious Args/Returns, but the module is complex enough that they help navigation. Leave most.
18. **session.py:83-89** — `get_agent_state` docstring is useful (describes migration)
19. **session.py:122-123** — `set_agent_state` docstring — obvious from name
20. **session.py:136-143** — `update_agent_state` docstring — useful (describes locking)
21. **council/base.py:78-86** — `build_command` docstring is useful (describes merge order)

### Annotation noise (type hints on every local)
- Generally not bad in this codebase. A few spots in cli.py where `list[str]` hints on locals are unnecessary but not worth changing.

### Over-classing / premature abstraction
- **agent.py** — `COMMAND_BUILDERS`, `RESPONSE_PARSERS`, `STREAM_TEXT_EXTRACTORS`, `STREAM_THINKING_EXTRACTORS` dispatch dicts + per-backend functions are fine — they're a registry pattern that actually has multiple concrete backends.
- **council/base.py** — `CouncilMember` dataclass with methods is fine — it has genuine state (session_id, process).
- **No premature abstraction issues found.** The code is well-factored.

### Obvious comments / comment noise
1. **cli.py:22-24** — `if TYPE_CHECKING:` block imports `ThreadStatus` but it's never used as a type annotation in cli.py. Dead import?
2. **state.py:80-82** — `runs_root` has docstring "DEPRECATED: Use branches_root() instead." — fine, leave it
3. **state.py:89-91** — `run_root` same deprecation note — fine
4. **state.py:149-150** — comment about temp name using pid+thread to avoid collisions — actually useful
5. **agent.py:22-24** — section divider comments (`# ---------------------------------------------------------------------------`) — cosmetic, widespread, harmless. Leave them.

### `Any` type usage
1. **agent.py:304** — `RESPONSE_PARSERS: dict[str, Any]` — could be typed with a proper Callable signature
2. **agent.py:427** — `COMMAND_BUILDERS: dict[str, Any]` — same
3. **agent.py:564** — `STREAM_TEXT_EXTRACTORS: dict[str, Any]` — same
4. **agent.py:627** — `STREAM_THINKING_EXTRACTORS: dict[str, Any]` — same
5. **session.py:128-129** — `data: dict[str, Any]` — fine (JSON dict)

### Redundant validation (config.py)
- **config.py:108-260** — The validation functions are thorough but very verbose. Each one manually checks isinstance() on every field. This is a config boundary, so validation is appropriate — but the pattern is repetitive. Not actionable without a schema library though. **Leave as-is.**

### Duplicate logic
1. **session.py:106-119** and **session.py:155-168** and **session.py:180-193** — `AgentState` reconstruction from dict is copy-pasted THREE times (in `get_agent_state`, `_apply` inside `update_agent_state`, and the return of `update_agent_state`). Extract a `agent_state_from_dict(data, name)` helper.
2. **harness.py:132-149** `append_worklog` and **ticket.py:495-563** `append_worklog_entry` — two different worklog append implementations. The harness one reads/writes via Ticket model, the ticket.py one manipulates raw text. Confusing duplication — should converge.

### Dead / unnecessary code
1. **cli.py:22-24** — `from typing import TYPE_CHECKING` + `ThreadStatus` import — grep shows `ThreadStatus` is used in type hint at line 935. Actually needed.
2. **state.py:80-91** — deprecated `runs_root` and `run_root` — still referenced by `logs_root`, `sessions_root`, `tickets_root` fallbacks. Keep for now.
3. **cli.py:3065-3085** — `format_ticket_summary` accepts `list` untyped (takes dict or Ticket) — could be tightened but works.

### Style nits
1. **agent.py:16** — `from kingdom.config import AgentDef` is a cross-module import at module level — fine
2. **state.py:161** — `fp = open(lock_path, "a+b")  # noqa: SIM115` — the noqa is needed because contextmanager can't use `with` here. Fine.
3. **cli.py** — Some functions like `council_ask` are 100+ lines. Not refactorable without losing clarity though.

## Action Items (ordered by impact)

1. **Extract `agent_state_from_dict` helper** in session.py to eliminate 3x copy-paste
2. **Remove parroting docstrings** — strip ~15 docstrings that restate the function name
3. **Type the dispatch dicts** in agent.py — replace `dict[str, Any]` with proper `Callable` types
4. **Rename `_apply` closures** in session.py — they violate the no-underscore rule
5. **Ruff + test suite pass** after all changes
