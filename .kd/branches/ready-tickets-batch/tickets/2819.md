---
id: 2819
status: closed
deps: []
links: []
created: 2026-02-14T02:16:27Z
type: feature
priority: 3
---
# Add kd whoami command for agent self-identification

Add a kd whoami command that prints the current agent's role — hand, council member (and which one), or peasant. This gives agents context about who they are in the system, which helps them behave appropriately. Could pull from environment variables, config, or session state to determine the role.

## Implementation Notes (council)

**Key files:** `src/kingdom/cli.py` (new command), `src/kingdom/session.py`, `src/kingdom/council/base.py`, `src/kingdom/harness.py`

**Approach — detection logic (in priority order):**
1. Check environment variables (`KD_ROLE`, `KD_AGENT_NAME`) — peasants/council set these when spawned
2. Check session state — active session with matching PID
3. Check if running inside a worktree (peasant indicator)
4. Fall back to "king" (interactive user)

**Plumbing required:**
- In `src/kingdom/council/base.py` (`CouncilMember.query`): inject `KD_ROLE=council` and `KD_AGENT_NAME={self.name}` into subprocess environment
- In `src/kingdom/harness.py` (`run_agent_loop`): inject `KD_ROLE=peasant` and `KD_AGENT_NAME={session_name}` into subprocess environment

**Gotchas:**
- Without env vars, detection is best-effort (PID matching is fragile)
- Council and harness need to set the env vars when spawning agents — that's additional plumbing beyond the CLI command itself
- Consider whether whoami should also work from SKILL.md prompt context

## Worklog

- Added `kd whoami` command to cli.py
- Detection: KD_ROLE env var (explicit) > CLAUDECODE env var (hand) > fallback (king)
- Extended `clean_agent_env()` in agent.py to accept optional `role` and `agent_name` params
- Council spawns inject KD_ROLE=council, KD_AGENT_NAME={member.name}
- Harness spawns inject KD_ROLE=peasant, KD_AGENT_NAME={session_name}
- CLAUDECODE detection: present = "hand" (Claude Code strips it for subprocesses via clean_agent_env)
- Manually verified: king (naked terminal), hand (Claude Code session), council/peasant (env vars)
