---
id: "20f6"
status: closed
deps: []
links: []
created: 2026-02-17T19:49:51Z
type: bug
priority: 1
---
# peasant stop must terminate full process tree

Bug: kd peasant stop can report stopped while backend child/grandchild processes continue running.

Required behavior:
- Stop command terminates harness and full process tree for that peasant session
- Use graceful TERM first, then force KILL after timeout if needed
- Session state reflects real process state (no stale running children after stopped)

Acceptance criteria:
- [x] Repro case with backend subprocesses leaves no lingering PIDs after stop
- [x] kd peasant status and session state are consistent with process reality
- [x] Regression tests cover child-process reaping

## Worklog

- Root cause: `peasant_stop` sent SIGTERM only to the harness PID via `os.kill()`. The backend (claude/codex) and its children (ty server, playwright, etc.) were in the same process group but never received the signal. The harness was launched with `start_new_session=True`, making it the process group leader.
- Fix: replaced `os.kill(pid, SIGTERM)` with `os.killpg(pgid, SIGTERM)` to kill the entire process group. Added a 5-second wait with polling, then SIGKILL fallback for stragglers.
- Updated existing test from `os.kill` mock to `os.killpg` mock.
- Added 3 new tests: process group kill, SIGKILL fallback when processes survive SIGTERM, and already-dead process group handling.
- Full suite: 1109 passed, 29 skipped, 1 xfailed. Ruff clean.
