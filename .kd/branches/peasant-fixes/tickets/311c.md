---
id: "311c"
status: closed
deps: []
links: []
created: 2026-02-17T18:56:31Z
type: task
priority: 2
---
# Fix timeout handler dumping raw JSONL into thread messages

## Description

When a council query times out (`subprocess.TimeoutExpired`), the timeout handler in `CouncilMember.query_once()` (`src/kingdom/council/base.py:245-262`) sets `AgentResponse.text` to the raw stdout without calling `parse_response()`. For codex, this means the entire JSONL event stream gets written to the thread message file as-is.

The normal (non-timeout) path at line 220 calls `self.parse_response()` which extracts just the `agent_message` text from codex JSONL. The timeout path skips that and dumps raw JSON.

Observed in the `peasant-fixes` council thread: codex was asked to launch a peasant, spent 10+ minutes polling with sleep loops, timed out, and produced a 161KB thread message of raw `{"type":"item.completed",...}` events.

## Fix

In the `TimeoutExpired` handler, call `self.parse_response()` on the partial stdout/stderr instead of using the raw string directly. Fall back to the raw partial if parsing yields no text (so non-JSONL backends still show something).

## Acceptance Criteria

- [x] Timeout handler in `query_once()` calls `parse_response()` on partial output
- [x] Codex timeout produces clean markdown in thread messages (agent_message text only)
- [x] Non-codex (claude) timeout still produces usable partial output
- [x] Test covering codex timeout â†’ parsed output

## Worklog

- Added failing test `test_query_timeout_parses_codex_jsonl` simulating codex JSONL timeout
- Fixed `TimeoutExpired` handler in `base.py` to call `parse_response()` on partial output
- Falls back to raw partial when parsing yields no text (preserves claude behavior)
- All 1099 tests pass
