---
id: d52d
status: closed
deps: []
links: []
created: 2026-02-14T14:12:16Z
type: task
priority: 2
---
# Create config.py with dataclasses and load/validate

Create `src/kingdom/config.py` with the config system's core data model and loading logic.

## Details

Dataclasses (all fields optional except `AgentDef.backend`):
- `AgentDef`: backend, model, prompt, prompts (dict[str, str]), extra_flags (list[str])
- `PromptsConfig`: council, design, review, peasant (all optional strings)
- `CouncilConfig`: members (list[str]), timeout (int, default 600)
- `PeasantConfig`: agent (str, default "claude"), timeout (int, default 900), max_iterations (int, default 50)
- `KingdomConfig`: agents (dict[str, AgentDef]), prompts (PromptsConfig), council (CouncilConfig), peasant (PeasantConfig)

Functions:
- `load_config(base: Path) -> KingdomConfig` — read `.kd/config.json`, return defaults if missing
- `validate_config(data: dict) -> KingdomConfig` — type check all fields, error on unknown keys, cross-reference validate (council.members and peasant.agent must reference defined agents)
- `default_config() -> KingdomConfig` — returns the built-in defaults (claude, codex, cursor agents; all on council; claude as peasant)

Default agents when no config exists: claude (claude_code), codex (codex), cursor (cursor).

## Acceptance Criteria

- [x] `KingdomConfig`, `AgentDef`, `PromptsConfig`, `CouncilConfig`, `PeasantConfig` dataclasses exist
- [x] `load_config` returns defaults when no file exists
- [x] `load_config` reads and validates `.kd/config.json` when present
- [x] Unknown keys in any section produce a hard error with the key name
- [x] Missing `backend` on an agent produces a hard error
- [x] `council.members` referencing an undefined agent produces a hard error listing defined agents
- [x] `peasant.agent` referencing an undefined agent produces a hard error
- [x] Tests cover: defaults, valid config, unknown keys, missing backend, bad cross-references

## Worklog

- Created `src/kingdom/config.py` with all 5 dataclasses, `load_config`, `validate_config`, `default_config`
- Created `tests/test_config.py` with 37 tests covering all acceptance criteria
- All tests pass, ruff clean
