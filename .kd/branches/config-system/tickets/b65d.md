---
id: b65d
status: closed
deps: [d52d, 5151]
links: []
created: 2026-02-14T14:12:21Z
type: task
priority: 2
---
# Wire config into council creation and prompt merging

Update council to build members from config instead of scanning `.kd/agents/`. Implement prompt merge order.

## Details

- `Council.create()` takes a `KingdomConfig` instead of scanning `.kd/agents/`. Build `CouncilMember` list from `config.council.members`.
- `CouncilMember.build_command()` implements prompt merge order: safety preamble (hardcoded) + phase prompt (agent-specific if set in `agent.prompts[phase]`, else global `config.prompts[phase]`) + agent prompt (`agent.prompt`) + user prompt.
- `Council.timeout` reads from `config.council.timeout`.
- `cli.py`: load config early, pass to `Council.create()`. CLI `--timeout` flag overrides config value.

## Acceptance Criteria

- [x] `Council.create()` accepts `KingdomConfig` and builds members from it
- [x] Council only includes agents listed in `config.council.members`
- [x] Prompt merge order is: preamble + phase prompt (agent-specific or global) + agent prompt + user prompt
- [x] Agent-specific phase prompt overrides global phase prompt for that agent
- [x] Council timeout comes from config, CLI `--timeout` overrides it
- [x] Tests cover: custom members, prompt merging, phase overrides, timeout precedence

## Worklog

- Council.create() and council.members filtering already done in ticket 5151
- Council.timeout from config already done in ticket 5151
- Added agent_prompt and phase_prompt fields to CouncilMember
- Updated build_command() with prompt merge order: preamble + phase + agent + user
- Council.create() resolves phase prompts (agent-specific overrides global)
- CLI --timeout changed to Optional[int] so config timeout isn't always overridden
- Added 8 new tests: 3 for Council.create prompt passing, 5 for prompt merge order
- All 50 council tests pass
