---
id: 5151
status: closed
deps: [d52d]
links: []
created: 2026-02-14T14:12:21Z
type: task
priority: 2
---
# Refactor agent.py: remove agent file code, add BACKEND_DEFAULTS

Remove all `.kd/agents/*.md` file handling and replace `DEFAULT_AGENTS` with `BACKEND_DEFAULTS`.

## Details

Remove from `agent.py`:
- `agents_root()`, `parse_agent_file()`, `serialize_agent_file()`, `load_agent()`, `list_agents()`, `create_default_agent_files()`
- `DEFAULT_AGENTS` dict
- The old `AgentConfig` dataclass (replaced by config.py's `AgentDef` for user config)

Add `BACKEND_DEFAULTS` dict mapping backend name to CLI invocation details:
- `cli`, `resume_flag`, `version_command`, `install_hint` per backend

Update `AgentConfig` to a runtime dataclass that merges `BACKEND_DEFAULTS` + `AgentDef` from config. This is what command builders consume.

Update command builders (`build_claude_command`, `build_codex_command`, `build_cursor_command`) to:
- Accept `model` and insert backend-appropriate flag (e.g., `--model` for Claude)
- Insert `extra_flags` before the prompt argument
- Warn if a backend doesn't support `model` via CLI

Keep `parsing.py` as-is â€” `parse_frontmatter()` is still used by tickets and threads.

## Acceptance Criteria

- [x] `agents_root`, `parse_agent_file`, `serialize_agent_file`, `load_agent`, `list_agents`, `create_default_agent_files` are removed
- [x] `DEFAULT_AGENTS` replaced by `BACKEND_DEFAULTS`
- [x] `AgentConfig` is a runtime dataclass merging backend defaults + user config
- [x] Command builders handle `model` per-backend
- [x] Command builders insert `extra_flags` before the prompt argument
- [x] Existing tests updated or removed to match
- [x] `parsing.py` untouched

## Worklog

- Rewrote agent.py: removed all file I/O functions, DEFAULT_AGENTS, added BACKEND_DEFAULTS, resolve_agent(), resolve_all_agents()
- AgentConfig now includes model and extra_flags fields
- Command builders insert --model and extra_flags before prompt
- Updated 4 call sites: council/council.py, harness.py, cli.py (init + doctor)
- Updated test_agent.py (44 tests), test_council.py, test_init.py
- 526/527 tests pass (1 pre-existing failure unrelated to this change)
