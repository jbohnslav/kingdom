---
id: 3f8e
status: closed
deps: [d52d, a9f1]
links: []
created: 2026-02-14T14:12:21Z
type: task
priority: 2
---
# Update kd doctor to validate config

Extend `kd doctor` to validate `.kd/config.json` and check backend CLIs.

## Details

- Parse `.kd/config.json` and report errors (invalid JSON, unknown keys, missing required fields, bad cross-references)
- For each agent defined in config, check that its backend CLI is installed using `BACKEND_DEFAULTS[backend]["version_command"]`
- Report missing CLIs with the `install_hint` from `BACKEND_DEFAULTS`
- If no config file exists, report that defaults are in use (not an error)

## Acceptance Criteria

- [x] `kd doctor` validates config JSON syntax
- [x] `kd doctor` reports unknown keys, missing fields, bad cross-references
- [x] `kd doctor` checks each configured agent's backend CLI is installed
- [x] Missing CLIs show install hints
- [x] No config file is reported as "using defaults" (not an error)
- [x] Existing doctor checks (non-config) still work

## Worklog

- Added check_config() function that validates config via load_config()
- Doctor now shows Config section before Agent CLIs section
- "No config.json (using defaults)" shown with yellow ○ when file is absent
- Config errors shown with red ✗ and detailed error message
- JSON output restructured: {"config": {...}, "agents": {...}}
- Updated existing tests, added 4 new tests (invalid config, no config, valid config, JSON invalid)
- Manually verified `kd doctor` and `kd doctor --json` output
- Reopened after integration repro: invalid config (e.g., `{"council":{"timout":123}}`) prints the config error, then crashes with traceback in both `kd doctor` and `kd doctor --json`.
- Root cause: `doctor()` continues into `get_doctor_checks(base)` even when `check_config()` reports invalid config; `get_doctor_checks()` calls `load_config(base)` and raises.
- Expected: report config error cleanly (and JSON output should still be valid JSON), not traceback.
- Fixed: guarded `get_doctor_checks()` behind `config_ok` — when config is invalid, CLI checks are skipped with "Skipped (fix config first)" message. JSON output returns empty agents dict.
- Fixed: `kd config show` now catches `ValueError` from `load_config()` and shows clean error instead of traceback.
- Added backend validation to `validate_agent()` — unknown backends (not in `VALID_BACKENDS`) are now hard errors at config load time.
- Added positive-value validation for `council.timeout`, `peasant.timeout`, and `peasant.max_iterations`.
- Rewrote doctor tests to use `tmp_path` with real invalid config files on disk instead of mocking `check_config`. Added `test_doctor_unknown_backend` and `test_config_show_invalid_config`.
- Added 5 new validation tests in test_config.py: unknown backend, positive council timeout, positive peasant timeout, positive max_iterations.
- Manually verified: `kd doctor`, `kd doctor --json`, `kd config show` all produce clean errors on invalid config (typo keys, unknown backends). No tracebacks.
- Full suite: 556 passed, 3 skipped. Ruff clean.
