---
from: king
to: all
timestamp: 2026-02-15T11:54:12Z
---

Review the implementation of ticket e756: switching council to stream-json and building NDJSON parsing. Here's a diff of all changes:

diff --git a/.kd/branches/council-improvements/tickets/e756.md b/.kd/branches/council-improvements/tickets/e756.md
index 5f0245e..0c8d125 100644
--- a/.kd/branches/council-improvements/tickets/e756.md
+++ b/.kd/branches/council-improvements/tickets/e756.md
@@ -1,6 +1,6 @@
 ---
 id: "e756"
-status: open
+status: in_progress
 deps: []
 links: []
 created: 2026-02-15T02:36:41Z
diff --git a/src/kingdom/agent.py b/src/kingdom/agent.py
index 1c9658b..ce13bbe 100644
--- a/src/kingdom/agent.py
+++ b/src/kingdom/agent.py
@@ -99,22 +99,56 @@ def resolve_all_agents(agents: dict[str, AgentDef]) -> dict[str, AgentConfig]:


 def parse_claude_response(stdout: str, stderr: str, code: int) -> tuple[str, str | None, str]:
-    """Parse claude CLI JSON output.
+    """Parse claude CLI JSON or NDJSON (stream-json) output.

-    Expected format::
+    Single-JSON format (``--output-format json``)::

         {"result": "response text", "session_id": "abc123"}
+
+    NDJSON format (``--output-format stream-json``): one JSON object per line.
+    Text is assembled from ``text_delta`` events; session_id from ``result`` event.
     """
     raw = stdout
-    try:
-        data = json.loads(stdout)
-        if not isinstance(data, dict):
+    lines = [ln for ln in stdout.strip().split("\n") if ln.strip()]
+
+    # Single-line: use original single-JSON parser
+    if len(lines) <= 1:
+        try:
+            data = json.loads(stdout)
+            if not isinstance(data, dict):
+                return stdout.strip(), None, raw
+            text = data.get("result", "")
+            session_id = data.get("session_id")
+            return text, session_id, raw
+        except json.JSONDecodeError:
             return stdout.strip(), None, raw
-        text = data.get("result", "")
-        session_id = data.get("session_id")
-        return text, session_id, raw
-    except json.JSONDecodeError:
-        return stdout.strip(), None, raw
+
+    # Multi-line: parse as NDJSON (stream-json)
+    text_parts: list[str] = []
+    session_id = None
+
+    for line in lines:
+        try:
+            event = json.loads(line)
+        except json.JSONDecodeError:
+            continue
+        if not isinstance(event, dict):
+            continue
+
+        event_type = event.get("type")
+
+        if event_type == "content_block_delta":
+            delta = event.get("delta", {})
+            if delta.get("type") == "text_delta":
+                text_parts.append(delta.get("text", ""))
+        elif event_type == "result":
+            session_id = event.get("session_id")
+            # result event also carries the final text
+            result_text = event.get("result")
+            if result_text and not text_parts:
+                text_parts.append(result_text)
+
+    return "".join(text_parts), session_id, raw


 def parse_codex_response(stdout: str, stderr: str, code: int) -> tuple[str, str | None, str]:
@@ -153,17 +187,57 @@ def parse_codex_response(stdout: str, stderr: str, code: int) -> tuple[str, str


 def parse_cursor_response(stdout: str, stderr: str, code: int) -> tuple[str, str | None, str]:
-    """Parse cursor agent CLI JSON output."""
+    """Parse cursor agent CLI JSON or NDJSON (stream-json) output.
+
+    Single-JSON format: ``{"result": "...", "session_id": "..."}``
+
+    NDJSON format: text from ``content_block_delta`` (text_delta) or ``assistant``
+    events; session_id from ``result`` event.
+    """
     raw = stdout
-    try:
-        data = json.loads(stdout)
-        if not isinstance(data, dict):
+    lines = [ln for ln in stdout.strip().split("\n") if ln.strip()]
+
+    # Single-line: use original single-JSON parser
+    if len(lines) <= 1:
+        try:
+            data = json.loads(stdout)
+            if not isinstance(data, dict):
+                return stdout.strip(), None, raw
+            text = data.get("result") or data.get("text") or data.get("response") or ""
+            session_id = data.get("session_id") or data.get("conversation_id")
+            return text, session_id, raw
+        except json.JSONDecodeError:
             return stdout.strip(), None, raw
-        text = data.get("result") or data.get("text") or data.get("response") or ""
-        session_id = data.get("session_id") or data.get("conversation_id")
-        return text, session_id, raw
-    except json.JSONDecodeError:
-        return stdout.strip(), None, raw
+
+    # Multi-line: parse as NDJSON (stream-json)
+    text_parts: list[str] = []
+    session_id = None
+
+    for line in lines:
+        try:
+            event = json.loads(line)
+        except json.JSONDecodeError:
+            continue
+        if not isinstance(event, dict):
+            continue
+
+        event_type = event.get("type")
+
+        if event_type == "content_block_delta":
+            delta = event.get("delta", {})
+            if delta.get("type") == "text_delta":
+                text_parts.append(delta.get("text", ""))
+        elif event_type == "assistant":
+            text = event.get("text", "")
+            if text:
+                text_parts.append(text)
+        elif event_type == "result":
+            session_id = event.get("session_id") or event.get("conversation_id")
+            result_text = event.get("result")
+            if result_text and not text_parts:
+                text_parts.append(result_text)
+
+    return "".join(text_parts), session_id, raw


 RESPONSE_PARSERS: dict[str, Any] = {
@@ -179,15 +253,28 @@ RESPONSE_PARSERS: dict[str, Any] = {


 def build_claude_command(
-    config: AgentConfig, prompt: str, session_id: str | None, skip_permissions: bool = True
+    config: AgentConfig,
+    prompt: str,
+    session_id: str | None,
+    skip_permissions: bool = True,
+    streaming: bool = False,
 ) -> list[str]:
     """Build claude CLI command.

     Format: ``claude [--dangerously-skip-permissions] [--model MODEL] --print --output-format json [--resume SESSION] -p PROMPT``

     When skip_permissions is False (council queries), restricts to read-only tools.
+    When streaming is True, replaces ``--output-format json`` with ``stream-json``
+    and appends ``--verbose`` and ``--include-partial-messages``.
     """
     cmd = shlex.split(config.cli)
+    if streaming:
+        try:
+            fmt_idx = cmd.index("--output-format")
+            cmd[fmt_idx + 1] = "stream-json"
+        except (ValueError, IndexError):
+            pass
+        cmd.extend(["--verbose", "--include-partial-messages"])
     if skip_permissions:
         cmd.insert(1, "--dangerously-skip-permissions")
     else:
@@ -203,13 +290,18 @@ def build_claude_command(


 def build_codex_command(
-    config: AgentConfig, prompt: str, session_id: str | None, skip_permissions: bool = True
+    config: AgentConfig,
+    prompt: str,
+    session_id: str | None,
+    skip_permissions: bool = True,
+    streaming: bool = False,
 ) -> list[str]:
     """Build codex CLI command.

     Codex uses subcommand-style resume: ``codex exec resume <id> --json <prompt>``

     When skip_permissions is False (council queries), uses read-only sandbox.
+    The streaming parameter is accepted but ignored — codex already outputs NDJSON.
     """
     parts = shlex.split(config.cli)
     if skip_permissions:
@@ -233,15 +325,26 @@ def build_codex_command(


 def build_cursor_command(
-    config: AgentConfig, prompt: str, session_id: str | None, skip_permissions: bool = True
+    config: AgentConfig,
+    prompt: str,
+    session_id: str | None,
+    skip_permissions: bool = True,
+    streaming: bool = False,
 ) -> list[str]:
     """Build cursor agent CLI command.

     Format: ``agent [--force --sandbox disabled] [--model MODEL] --print --output-format json PROMPT [--resume SESSION]``

     When skip_permissions is False (council queries), uses --mode ask for read-only.
+    When streaming is True, replaces ``--output-format json`` with ``stream-json``.
     """
     cmd = shlex.split(config.cli)
+    if streaming:
+        try:
+            fmt_idx = cmd.index("--output-format")
+            cmd[fmt_idx + 1] = "stream-json"
+        except (ValueError, IndexError):
+            pass
     if skip_permissions:
         cmd.insert(1, "--force")
         cmd.insert(2, "--sandbox")
@@ -284,7 +387,11 @@ def clean_agent_env(role: str | None = None, agent_name: str | None = None) -> d


 def build_command(
-    config: AgentConfig, prompt: str, session_id: str | None = None, skip_permissions: bool = True
+    config: AgentConfig,
+    prompt: str,
+    session_id: str | None = None,
+    skip_permissions: bool = True,
+    streaming: bool = False,
 ) -> list[str]:
     """Build a CLI command for an agent.

@@ -296,7 +403,7 @@ def build_command(
     builder = COMMAND_BUILDERS.get(config.backend)
     if builder is None:
         raise ValueError(f"Unknown backend: {config.backend}")
-    return builder(config, prompt, session_id, skip_permissions)
+    return builder(config, prompt, session_id, skip_permissions, streaming=streaming)


 def parse_response(config: AgentConfig, stdout: str, stderr: str, code: int) -> tuple[str, str | None, str]:
@@ -309,3 +416,81 @@ def parse_response(config: AgentConfig, stdout: str, stderr: str, code: int) ->
     if parser is None:
         return stdout.strip(), None, stdout
     return parser(stdout, stderr, code)
+
+
+# ---------------------------------------------------------------------------
+# Stream text extractors — extract text from individual NDJSON lines
+# ---------------------------------------------------------------------------
+
+
+def extract_claude_stream_text(line: str) -> str | None:
+    """Extract text from a single Claude stream-json NDJSON line.
+
+    Returns the text fragment from ``content_block_delta`` / ``text_delta``
+    events, or None for non-text events.
+    """
+    try:
+        event = json.loads(line)
+    except json.JSONDecodeError:
+        return None
+    if not isinstance(event, dict):
+        return None
+    if event.get("type") == "content_block_delta":
+        delta = event.get("delta", {})
+        if delta.get("type") == "text_delta":
+            return delta.get("text")
+    return None
+
+
+def extract_codex_stream_text(line: str) -> str | None:
+    """Extract text from a single Codex NDJSON line.
+
+    Returns agent message text from ``item.completed`` events, or None.
+    """
+    try:
+        event = json.loads(line)
+    except json.JSONDecodeError:
+        return None
+    if not isinstance(event, dict):
+        return None
+    if event.get("type") == "item.completed":
+        item = event.get("item", {})
+        if item.get("type") == "agent_message":
+            return item.get("text")
+    return None
+
+
+def extract_cursor_stream_text(line: str) -> str | None:
+    """Extract text from a single Cursor stream-json NDJSON line.
+
+    Returns text from ``content_block_delta`` / ``text_delta`` events, or None.
+    """
+    try:
+        event = json.loads(line)
+    except json.JSONDecodeError:
+        return None
+    if not isinstance(event, dict):
+        return None
+    if event.get("type") == "content_block_delta":
+        delta = event.get("delta", {})
+        if delta.get("type") == "text_delta":
+            return delta.get("text")
+    return None
+
+
+STREAM_TEXT_EXTRACTORS: dict[str, Any] = {
+    "claude_code": extract_claude_stream_text,
+    "codex": extract_codex_stream_text,
+    "cursor": extract_cursor_stream_text,
+}
+
+
+def extract_stream_text(line: str, backend: str) -> str | None:
+    """Extract text from a single NDJSON line for the given backend.
+
+    Returns None for non-text events or unknown backends.
+    """
+    extractor = STREAM_TEXT_EXTRACTORS.get(backend)
+    if extractor is None:
+        return None
+    return extractor(line)
diff --git a/src/kingdom/council/base.py b/src/kingdom/council/base.py
index 305a85a..84310a6 100644
--- a/src/kingdom/council/base.py
+++ b/src/kingdom/council/base.py
@@ -62,7 +62,7 @@ class CouncilMember:
             parts.append(self.agent_prompt + "\n\n")
         parts.append(prompt)
         full_prompt = "".join(parts)
-        return agent_build_command(self.config, full_prompt, self.session_id, skip_permissions=False)
+        return agent_build_command(self.config, full_prompt, self.session_id, skip_permissions=False, streaming=True)

     def parse_response(self, stdout: str, stderr: str, code: int) -> tuple[str, str | None, str]:
         """Parse response from CLI output.
diff --git a/src/kingdom/council/council.py b/src/kingdom/council/council.py
index 8c33295..3415ce8 100644
--- a/src/kingdom/council/council.py
+++ b/src/kingdom/council/council.py
@@ -109,7 +109,7 @@ class Council:
             futures = {}
             for member in self.members:
                 # Stream to .stream-{member}.md
-                stream_path = tdir / f".stream-{member.name}.md"
+                stream_path = tdir / f".stream-{member.name}.jsonl"
                 futures[executor.submit(member.query, prompt, self.timeout, stream_path)] = (member, stream_path)

             for future in as_completed(futures):
diff --git a/src/kingdom/council/worker.py b/src/kingdom/council/worker.py
index 79b116a..45fc9ca 100644
--- a/src/kingdom/council/worker.py
+++ b/src/kingdom/council/worker.py
@@ -49,7 +49,7 @@ def main(argv: list[str] | None = None) -> None:

         tdir = thread_dir(args.base, args.feature, args.thread_id)
         tdir.mkdir(parents=True, exist_ok=True)
-        stream_path = tdir / f".stream-{member.name}.md"
+        stream_path = tdir / f".stream-{member.name}.jsonl"

         response = member.query(args.prompt, args.timeout, stream_path=stream_path)
         body = response.text if response.text else f"*Error: {response.error}*"
diff --git a/tests/test_agent.py b/tests/test_agent.py
index 6394425..f549064 100644
--- a/tests/test_agent.py
+++ b/tests/test_agent.py
@@ -6,6 +6,7 @@ from kingdom.agent import (
     BACKEND_DEFAULTS,
     AgentConfig,
     build_command,
+    extract_stream_text,
     parse_claude_response,
     parse_codex_response,
     parse_cursor_response,
@@ -372,3 +373,127 @@ class TestParseResponseDispatch:
         text, session_id, _ = parse_response(config, "raw output", "", 0)
         assert text == "raw output"
         assert session_id is None
+
+
+class TestBuildCommandStreaming:
+    def test_claude_streaming_replaces_output_format(self) -> None:
+        cmd = build_command(make_config("claude"), "hello", streaming=True)
+        assert "--output-format" in cmd
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "stream-json"
+        assert "--verbose" in cmd
+        assert "--include-partial-messages" in cmd
+
+    def test_claude_streaming_false_keeps_json(self) -> None:
+        cmd = build_command(make_config("claude"), "hello", streaming=False)
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "json"
+        assert "--verbose" not in cmd
+        assert "--include-partial-messages" not in cmd
+
+    def test_cursor_streaming_replaces_output_format(self) -> None:
+        cmd = build_command(make_config("cursor"), "hello", streaming=True)
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "stream-json"
+
+    def test_cursor_streaming_false_keeps_json(self) -> None:
+        cmd = build_command(make_config("cursor"), "hello", streaming=False)
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "json"
+
+    def test_codex_streaming_unchanged(self) -> None:
+        cmd_normal = build_command(make_config("codex"), "hello", streaming=False)
+        cmd_stream = build_command(make_config("codex"), "hello", streaming=True)
+        assert cmd_normal == cmd_stream
+
+
+class TestParseClaudeResponseNDJSON:
+    def test_ndjson_text_delta_joining(self) -> None:
+        stdout = (
+            '{"type":"content_block_delta","delta":{"type":"text_delta","text":"Hello"}}\n'
+            '{"type":"content_block_delta","delta":{"type":"text_delta","text":" world"}}\n'
+            '{"type":"result","session_id":"sess-abc"}\n'
+        )
+        text, session_id, _ = parse_claude_response(stdout, "", 0)
+        assert text == "Hello world"
+        assert session_id == "sess-abc"
+
+    def test_ndjson_result_fallback_text(self) -> None:
+        """When no text_delta events, fall back to result event text."""
+        stdout = '{"type":"result","result":"Final answer","session_id":"s1"}\n{"type":"system","status":"done"}\n'
+        text, session_id, _ = parse_claude_response(stdout, "", 0)
+        assert text == "Final answer"
+        assert session_id == "s1"
+
+    def test_single_json_still_works(self) -> None:
+        stdout = '{"result": "hello", "session_id": "sess-123"}'
+        text, session_id, _ = parse_claude_response(stdout, "", 0)
+        assert text == "hello"
+        assert session_id == "sess-123"
+
+    def test_ndjson_skips_non_text_events(self) -> None:
+        stdout = (
+            '{"type":"tool_use","name":"Read"}\n'
+            '{"type":"content_block_delta","delta":{"type":"text_delta","text":"answer"}}\n'
+            '{"type":"result","session_id":"s2"}\n'
+        )
+        text, session_id, _ = parse_claude_response(stdout, "", 0)
+        assert text == "answer"
+        assert session_id == "s2"
+
+    def test_ndjson_invalid_json_lines_skipped(self) -> None:
+        stdout = 'not json\n{"type":"content_block_delta","delta":{"type":"text_delta","text":"ok"}}\n'
+        text, _, _ = parse_claude_response(stdout, "", 0)
+        assert text == "ok"
+
+
+class TestParseCursorResponseNDJSON:
+    def test_ndjson_content_block_delta(self) -> None:
+        stdout = (
+            '{"type":"content_block_delta","delta":{"type":"text_delta","text":"Hi"}}\n'
+            '{"type":"content_block_delta","delta":{"type":"text_delta","text":" there"}}\n'
+            '{"type":"result","session_id":"conv-1"}\n'
+        )
+        text, session_id, _ = parse_cursor_response(stdout, "", 0)
+        assert text == "Hi there"
+        assert session_id == "conv-1"
+
+    def test_ndjson_assistant_type(self) -> None:
+        stdout = '{"type":"assistant","text":"response text"}\n{"type":"result","conversation_id":"c-2"}\n'
+        text, session_id, _ = parse_cursor_response(stdout, "", 0)
+        assert text == "response text"
+        assert session_id == "c-2"
+
+    def test_single_json_still_works(self) -> None:
+        stdout = '{"result":"OK","session_id":"abc123"}'
+        text, session_id, _ = parse_cursor_response(stdout, "", 0)
+        assert text == "OK"
+        assert session_id == "abc123"
+
+
+class TestExtractStreamText:
+    def test_claude_text_delta(self) -> None:
+        line = '{"type":"content_block_delta","delta":{"type":"text_delta","text":"hi"}}'
+        assert extract_stream_text(line, "claude_code") == "hi"
+
+    def test_claude_non_text_event(self) -> None:
+        line = '{"type":"tool_use","name":"Read"}'
+        assert extract_stream_text(line, "claude_code") is None
+
+    def test_codex_item_completed(self) -> None:
+        line = '{"type":"item.completed","item":{"type":"agent_message","text":"done"}}'
+        assert extract_stream_text(line, "codex") == "done"
+
+    def test_codex_non_message_event(self) -> None:
+        line = '{"type":"turn.started"}'
+        assert extract_stream_text(line, "codex") is None
+
+    def test_cursor_text_delta(self) -> None:
+        line = '{"type":"content_block_delta","delta":{"type":"text_delta","text":"yo"}}'
+        assert extract_stream_text(line, "cursor") == "yo"
+
+    def test_unknown_backend(self) -> None:
+        assert extract_stream_text('{"type":"foo"}', "unknown") is None
+
+    def test_invalid_json(self) -> None:
+        assert extract_stream_text("not json", "claude_code") is None
diff --git a/tests/test_council.py b/tests/test_council.py
index a1952b4..d9b4fc6 100644
--- a/tests/test_council.py
+++ b/tests/test_council.py
@@ -71,6 +71,11 @@ class TestClaudeMember:
         assert "-p" in cmd
         assert PREAMBLE + "hello world" in cmd
         assert "--dangerously-skip-permissions" not in cmd
+        # Council uses streaming=True
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "stream-json"
+        assert "--verbose" in cmd
+        assert "--include-partial-messages" in cmd

     def test_build_command_with_session(self) -> None:
         member = make_member("claude")
@@ -80,6 +85,8 @@ class TestClaudeMember:
         assert "abc123" in cmd
         assert "--allowedTools" in cmd
         assert PREAMBLE + "hello" in cmd
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "stream-json"


 class TestCodexMember:
@@ -128,7 +135,8 @@ class TestCursorAgentMember:
         assert cmd[0] == "agent"
         assert "--print" in cmd  # required for non-interactive use
         assert "--output-format" in cmd
-        assert "json" in cmd
+        fmt_idx = cmd.index("--output-format")
+        assert cmd[fmt_idx + 1] == "stream-json"
         assert PREAMBLE + "hello world" in cmd
         # prompt is positional, not with -p flag
         assert "-p" not in cmd

Key design decisions to review:
1. streaming param added to all command builders (claude/cursor use it, codex ignores it)
2. Auto-detect in parsers: single-line = old JSON path, multi-line = NDJSON path (preserves backward compat for peasant path)
3. extract_stream_text() + STREAM_TEXT_EXTRACTORS dict for live line-by-line text extraction (follows existing RESPONSE_PARSERS/COMMAND_BUILDERS pattern)
4. Stream files renamed .md → .jsonl
5. Council path gets streaming=True, peasant path stays streaming=False

Please review for correctness, edge cases, and any concerns.
