---
id: "6412"
status: closed
deps: [e756]
links: []
created: 2026-02-14T17:43:26Z
type: task
priority: 1
---
# Council async UX is broken: no visibility, no retry, silent failures

## Problem

The council async flow has major UX gaps. Real example from the config-system review:

1. **Silent failures with no useful error**: Claude returned `Error: None` twice in a row. Cursor also returned `Error: None` on the same query. No indication of *why* — no stderr, no timeout message, no partial output. The king had to notice "check on claude, any logs? anything?" and manually investigate.

2. **No automatic retry**: After two failures, the only fix was `kd council reset` (nuke all sessions) and manually re-send the query. There's no per-member retry, no "retry failed members" command, no automatic backoff.

3. **No visibility while running**: Background council queries give no progress indication. The king sees "Running in background" and then... nothing until it either works or silently fails. No streaming, no heartbeat, no "claude is thinking..." status.

4. **Reset is a sledgehammer**: `kd council reset` clears ALL sessions. If codex was working fine and claude was broken, you still nuke codex's session to fix claude. Need per-member session management.

5. **`--async` + `watch` flow is fragile**: The watch command depends on the thread completing within timeout, but if a member silently hangs, watch just waits until timeout with no feedback.

## Acceptance Criteria

- [x] Failed council members show a meaningful error (not `Error: None`)
- [x] `kd council ask` retries failed members automatically (at least once)
- [x] Per-member session reset (`kd council reset --member claude`)
- [x] `watch_thread()` tails `.stream-{member}.jsonl` files and displays incremental text during execution (extract `text_delta` text, show accumulated text per member, replace with final response when message file lands)
- [x] `kd council retry <thread-id>` to re-query only failed members in a thread

## Worklog

### Implementation

**1. Meaningful error messages (base.py)**
- Added detection for empty-text-with-zero-exit case: `"Empty response from {name}: {snippet}"`
- Added `AgentResponse.thread_body()` method — single place for formatting response body for thread messages
- Replaced all inline `response.text if response.text else f"*Error: {response.error}*"` with `response.thread_body()`
- Eliminates the `*Error: None*` bug at the source

**2. Automatic retry (base.py)**
- Refactored `query()` into `query()` (retry wrapper) + `query_once()` (single attempt)
- Retry strategy: attempt 1 → retry with same session → retry with session reset
- Non-retriable errors (Command not found, Invalid agent config) fail immediately
- `max_retries` parameter (default 2) allows tests to disable retries
- `log_retry()` records retry attempts in the council log

**3. Per-member session reset (cli.py)**
- Added `--member` option to `kd council reset`
- Validates member exists, clears just that member's session
- Without `--member`, clears all sessions (unchanged behavior)

**4. `kd council retry` command (cli.py)**
- Reads thread to find last king message (the prompt to retry)
- Identifies failed members: those with `*Error:` or `*Empty response` body, or no response at all
- Filters council to only failed members, re-queries with original prompt
- Uses `query_to_thread()` so responses are written to the same thread

**5. Stream file display in watch_thread() (cli.py)**
- Replaced Progress spinner with Rich Live for dynamic multi-line display
- Tracks `.stream-{member}.jsonl` file positions and accumulated text per member
- Uses `extract_stream_text()` to get readable prose from NDJSON events
- Shows per-member status: "streaming (N chars) preview..." or "waiting..."
- Prints final response panels above live area when message files land
- Loads agent configs to resolve backends for correct text extractors
- Polls every 250ms (was 500ms) for more responsive streaming display

### Review follow-up (2026-02-15)

Reopened after validation found a correctness gap:

- AgentResponse.thread_body returns text when both text and error are present (src/kingdom/council/base.py).
- Timeout partials are therefore persisted as plain text with no error marker.
- kd council retry and thread_response_status classify failures using message-body error markers (src/kingdom/cli.py and src/kingdom/thread.py).
- Result: timeout-cutoff responses can be misclassified as success and skipped by retry/status.

Additional drift noted in same ticket scope:

- CouncilMember.NON_RETRIABLE_PREFIXES includes Timeout after, so automatic retries do not run on timeout (src/kingdom/council/base.py).

Backlog ticket 9124 tracks structured error and complete metadata, but 6412 remains functionally incomplete until timeout-partial failures are reliably detectable by retry/status.
