---
id: "e756"
status: closed
deps: []
links: []
created: 2026-02-15T02:36:41Z
type: task
priority: 1
---
# Switch council to stream-json and build NDJSON parsing for live streaming

## Description

Phase 0 foundation work. The council currently uses `--output-format json` for Claude Code and Cursor, which buffers all output until process exit. Both CLIs support `--output-format stream-json` which emits NDJSON (one JSON object per line) as tokens arrive. Switching to stream-json makes `.stream-{member}.jsonl` files genuinely useful for live display.

This ticket covers the plumbing â€” command builder changes, NDJSON parsers, and stream-line extractors. Consuming the stream files (watch, TUI) is in separate tickets.

## Acceptance Criteria

- [x] `build_command()` gains a `streaming=True` parameter; when set, Claude uses `--output-format stream-json --verbose --include-partial-messages` and Cursor uses `--output-format stream-json` instead of `--output-format json`
- [x] Council query path (`CouncilMember.query()`) passes `streaming=True` to build_command
- [x] Stream files renamed from `.stream-{member}.md` to `.stream-{member}.jsonl`
- [x] `parse_claude_response()` handles NDJSON stdout: joins text from `text_delta` events, extracts session_id from result event
- [x] `parse_cursor_response()` handles NDJSON stdout: joins text from delta events, extracts session_id
- [x] New `extract_stream_text(line, backend)` function: given a single NDJSON line, returns the human-readable text fragment (if any) for real-time display. Designed for reuse by both `watch_thread()` (CLI) and the TUI (`kd chat`)
- [x] Codex parser unchanged (already NDJSON-shaped)
- [x] Existing tests updated; new tests cover NDJSON parsing for Claude and Cursor
- [x] Non-streaming paths (peasant workers) still use `--output-format json` by default
